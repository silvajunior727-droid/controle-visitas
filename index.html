<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Visitas - Arlinda Batista Passos</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icone-192.png">
    <meta name="theme-color" content="#3498db">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e2e8f0; min-height: 100vh; display: flex; flex-direction: column; }

        /* TELA DE LOGIN */
        #tela-login { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100%; padding: 20px; }
        .cartao-login { background-color: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        .cartao-login h2 { color: #2c3e50; margin-bottom: 5px; }
        .cartao-login p { color: #7f8c8d; margin-bottom: 25px; font-size: 14px; }
        
        .input-grupo { margin-bottom: 15px; position: relative; }
        .input-grupo input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #senha-acesso { padding-right: 45px; }
        .olhinho { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; user-select: none; }
        
        button { width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #3498db; box-shadow: 0 5px #2980b9; transition: all 0.1s; margin-bottom: 10px; }
        button:active { box-shadow: 0 2px #2980b9; transform: translateY(3px); }
        #mensagem-erro { color: #e74c3c; margin-top: 15px; display: none; font-weight: bold; }

        /* TELA DO PAINEL */
        #tela-painel { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        /* Cabe√ßalho */
        .cabecalho-paciente { display: flex; align-items: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; flex-wrap: wrap; }
        .foto-container { width: 90px; height: 90px; border-radius: 50%; overflow: hidden; border: 4px solid #3498db; margin-right: 20px; background-color: #ecf0f1; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .foto-paciente { width: 100%; height: 100%; object-fit: cover; }
        .info-paciente { flex-grow: 1; }
        .info-paciente h2 { color: #2c3e50; font-size: 24px; }
        .info-paciente p { color: #7f8c8d; font-size: 16px; margin-top: 5px; }
        .mensagem-boas-vindas { color: #27ae60; font-size: 15px; margin-top: 8px !important; }
        
        .btn-sair { background-color: #e74c3c; box-shadow: 0 5px #c0392b; width: auto; padding: 10px 25px; margin-bottom: 0; margin-left: auto;}
        .btn-sair:active { box-shadow: 0 2px #c0392b; }
        
        /* Grade Semanal e Navega√ß√£o no Tempo */
        .semana-container { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .semana-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #2c3e50; flex-wrap: wrap; gap: 10px; }
        
        .navegacao-semana { display: flex; gap: 10px; align-items: center; }
        .btn-nav { background-color: #ecf0f1; color: #2c3e50; box-shadow: 0 4px #bdc3c7; padding: 8px 15px; font-size: 14px; width: auto; margin: 0; }
        .btn-nav:active { box-shadow: 0 2px #bdc3c7; }
        .btn-hoje { background-color: #34495e; color: white; box-shadow: 0 4px #2c3e50; }
        .btn-hoje:active { box-shadow: 0 2px #2c3e50; }

        .grade-dias { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .dia-coluna { display: flex; flex-direction: column; gap: 10px; }
        .dia-titulo { text-align: center; font-weight: bold; color: #34495e; padding-bottom: 5px; border-bottom: 2px solid #ecf0f1; font-size: 14px; }
        .dia-titulo span { display: block; font-size: 12px; color: #7f8c8d; font-weight: normal; }
        
        /* BLOCOS DOS TURNOS - AGORA √öNICO */
        .turno-bloco { padding: 15px 10px; border-radius: 8px; text-align: center; font-weight: bold; color: white; cursor: pointer; font-size: 14px; box-shadow: 0 5px rgba(0,0,0,0.3); transition: all 0.1s; display: flex; flex-direction: column; justify-content: flex-start; min-height: 120px; }
        .turno-bloco:active { box-shadow: 0 2px rgba(0,0,0,0.3); transform: translateY(3px); }
        .turno-unico { background-color: #34495e; border: 2px solid #2c3e50; } 

        /* RET√ÇNGULOS INTELIGENTES DAS HORAS ESCOLHIDAS */
        .horario-grupo { background: rgba(255, 255, 255, 0.95); border-radius: 6px; padding: 6px; margin-bottom: 10px; text-align: left; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .horario-header { font-size: 12px; font-weight: bold; padding: 5px; border-radius: 4px; color: white; text-align: center; margin-bottom: 6px; }
        .horario-nomes { font-size: 13px; line-height: 1.5; color: #2c3e50; font-weight: normal; padding-left: 5px; }
        
        /* CORES DIN√ÇMICAS POR QUANTIDADE */
        .cor-hora-0 { background-color: #95a5a6; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } /* Ningu√©m - Cinza */
        .cor-hora-1 { background-color: #2ecc71; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } /* 1 Pessoa - Verde */
        .cor-hora-2 { background-color: #f1c40f; color: #2c3e50 !important; } /* 2 Pessoas - Amarelo (sem sombra p/ ler melhor) */
        .cor-hora-3 { background-color: #e67e22; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } /* 3-4 Pessoas - Laranja */
        .cor-hora-4 { background-color: #e74c3c; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } /* 5+ Pessoas - Vermelho */

        .cor-hora-2 { color: #2c3e50; } /* Ajuste de cor de fonte para o amarelo */

        /* Observa√ß√µes e Bot√µes do Rodap√© */
        .observacoes-container { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        textarea { width: 100%; height: 150px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; resize: none; font-family: inherit; margin-bottom: 15px; line-height: 1.5; }
        
        .botoes-rodape { display: flex; gap: 15px; flex-wrap: wrap; }
        .botoes-rodape button { flex: 1; margin-bottom: 0; min-width: 200px; } 
        .btn-relatorio { background-color: #9b59b6; box-shadow: 0 5px #8e44ad; }
        .btn-relatorio:active { box-shadow: 0 2px #8e44ad; }
        .btn-whatsapp { background-color: #25D366; box-shadow: 0 5px #128C7E; }
        .btn-whatsapp:active { box-shadow: 0 2px #128C7E; }

        /* NOVA JANELA MODAL (DIN√ÇMICA) */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; padding: 10px; }
        .modal-conteudo { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-conteudo h3 { color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        
        .lista-visitas-modal { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .item-visita-modal { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed #ccc; font-size: 14px; color: #34495e; }
        .item-visita-modal:last-child { border-bottom: none; }
        .btn-apagar-modal { background: #fadbd8; color: #c0392b; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; box-shadow: none; width: auto; margin: 0; }
        .btn-apagar-modal:hover { background: #f5b7b1; }

        .form-nova-visita { background: #eaf2f8; padding: 15px; border-radius: 8px; border: 1px solid #d4e6f1; }
        .form-nova-visita label { font-size: 13px; font-weight: bold; color: #2980b9; margin-bottom: 10px; display: block; }
        .form-nova-visita input[type="text"] { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; margin-bottom: 10px; }
        
        .linha-horario { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #34495e; }
        .linha-horario input[type="text"].input-hora { padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 15px; flex: 1; text-align: center; font-weight: bold; color: #2c3e50;}
        .aviso-regra { font-size: 11px; color: #7f8c8d; margin-top: 8px; line-height: 1.3; }

        .modal-botoes { display: flex; gap: 10px; margin-top: 20px; }
        .btn-salvar { background-color: #2ecc71; box-shadow: 0 5px #27ae60; flex: 1; margin-bottom: 0; } 
        .btn-salvar:active { box-shadow: 0 2px #27ae60; }
        .btn-cancelar { background-color: #95a5a6; box-shadow: 0 5px #7f8c8d; flex: 1; margin-bottom: 0;} 
        .btn-cancelar:active { box-shadow: 0 2px #7f8c8d; }

        /* TELA DE RELAT√ìRIO */
        #tela-relatorio { display: none; padding: 40px; background: white; width: 98%; max-width: 1400px; margin: 20px auto; align-self: center; box-shadow: 0 10px 30px rgba(0,0,0,0.15); border-radius: 12px; }
        .botoes-relatorio { display: flex; gap: 15px; margin-bottom: 30px; width: 100%; justify-content: center; }
        .btn-voltar-suave { background-color: #a29bfe; box-shadow: 0 5px #6c5ce7; flex: 1; max-width: 300px; color: white; margin-bottom: 0; }
        .btn-voltar-suave:active { box-shadow: 0 2px #6c5ce7; }
        .btn-imprimir-suave { background-color: #74b9ff; box-shadow: 0 5px #0984e3; flex: 1; max-width: 300px; color: white; margin-bottom: 0; }
        .btn-imprimir-suave:active { box-shadow: 0 2px #0984e3; }
        .relatorio-cabecalho { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #2c3e50; padding-bottom: 10px; }
        .relatorio-cabecalho h1 { color: #2c3e50; }
        .tabela-wrapper { width: 100%; overflow-x: auto; margin-bottom: 30px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tabela-relatorio { width: 100%; min-width: 600px; border-collapse: collapse; }
        .tabela-relatorio th, .tabela-relatorio td { border: 1px solid #bdc3c7; padding: 12px; text-align: left; vertical-align: top;}
        .tabela-relatorio th { background-color: #ecf0f1; color: #2c3e50; }
        .obs-relatorio { background: #f9f9f9; padding: 20px; border-left: 5px solid #3498db; border-radius: 0 8px 8px 0; }

        @media (max-width: 768px) {
            .cabecalho-paciente { flex-direction: column; text-align: center; }
            .foto-container { margin: 0 auto 15px auto; }
            .btn-sair { margin: 15px auto 0 auto; width: 100%; }
            .navegacao-semana { width: 100%; justify-content: space-between; }
            .btn-nav { flex: 1; padding: 10px; }
            .grade-dias { grid-template-columns: 1fr; }
            #tela-painel { padding: 10px; }
            .semana-container, .observacoes-container, .cabecalho-paciente { padding: 15px; }
            .botoes-rodape { flex-direction: column; gap: 10px; }
            .botoes-rodape button { width: 100%; }
            #tela-relatorio { padding: 15px; margin: 0; width: 100%; max-width: 100%; border-radius: 0; align-self: stretch; }
            .botoes-relatorio { flex-direction: column; align-items: center; }
            .btn-voltar-suave, .btn-imprimir-suave { max-width: 100%; width: 100%; }
        }

        /* NOVAS REGRAS DE IMPRESS√ÉO (MAIS COMPACTO E CENTRALIZADO) */
        @media print {
            body { font-size: 12px; background: white; margin: 0; padding: 0; }
            .no-print { display: none !important; }
            #tela-painel, #tela-login, #modal-overlay { display: none !important; }
            
            #tela-relatorio { 
                display: block !important; 
                margin: 0 auto !important; /* Centraliza a folha */
                width: 85% !important; /* Reduz a largura para ficar mais estrito */
                max-width: 800px !important;
                padding: 15px !important; 
                box-shadow: none !important; 
                border-radius: 0 !important; 
            }
            .relatorio-cabecalho { margin-bottom: 15px; padding-bottom: 5px; }
            .relatorio-cabecalho h1 { font-size: 18px; margin-bottom: 5px; }
            .relatorio-cabecalho p { font-size: 12px; margin-bottom: 5px; }
            
            h3 { font-size: 14px; margin-top: 15px; margin-bottom: 10px; }
            
            .tabela-wrapper { overflow-x: visible; box-shadow: none; margin-bottom: 15px; }
            .tabela-relatorio { min-width: 100%; }
            .tabela-relatorio th, .tabela-relatorio td { padding: 6px; font-size: 11px; } /* Fonte e preenchimento menores na tabela */
            
            tr { page-break-inside: avoid; break-inside: avoid; }
            .obs-relatorio { padding: 10px; font-size: 11px; page-break-inside: avoid; break-inside: avoid; }
        }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="cartao-login">
            <h2>Controle de Visitas</h2>
            <p>Paciente: Arlinda Batista Passos</p>
            <div class="input-grupo"><input type="text" id="nome-visitante" placeholder="Seu Nome (Visitante/Cuidador)" required></div>
            
            <div class="input-grupo">
                <input type="password" id="senha-acesso" placeholder="Senha de Acesso" required>
                <span class="olhinho" onclick="toggleSenha()">üëÅÔ∏è</span>
            </div>
            
            <button onclick="fazerLogin()">Entrar</button>
            <p id="mensagem-erro">Senha incorreta ou nome em branco!</p>
        </div>
    </div>

    <div id="tela-painel">
        <div class="cabecalho-paciente">
            <div class="foto-container">
                <img src="mae.jpg" alt="Foto Dona Arlinda" class="foto-paciente" onerror="this.src='https://via.placeholder.com/90?text=Sem+Foto'">
            </div>
            <div class="info-paciente">
                <h2>Arlinda Batista Passos</h2>
                <p><strong>Rua:</strong> √Ågua Marinha, <strong></strong>409</p>
                <p id="boas-vindas-texto" class="mensagem-boas-vindas"></p>
            </div>
            <button class="btn-sair" onclick="sairDoSistema()">Sair</button>
        </div>

        <div class="semana-container">
            <div class="semana-header">
                <div>
                    <h3>Agenda de Visitas/Cuidadores</h3>
                    <p id="texto-periodo"><strong>Exibindo:</strong> Hoje e pr√≥ximos 6 dias</p>
                </div>
                
                <div class="navegacao-semana">
                    <button class="btn-nav" onclick="mudarSemana(-7)">‚¨ÖÔ∏è Ant.</button>
                    <button class="btn-nav btn-hoje" onclick="irParaHoje()">Hoje</button>
                    <button class="btn-nav" onclick="mudarSemana(7)">Pr√≥x. ‚û°Ô∏è</button>
                </div>
            </div>
            <div class="grade-dias" id="grade-dias"></div>
        </div>

        <div class="observacoes-container">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 10px;">
                <h3 style="margin-bottom: 0;">Informa√ß√µes Relevantes</h3>
                <button onclick="inserirDataObs()" style="background-color: #f39c12; box-shadow: 0 4px #e67e22; width: auto; padding: 6px 15px; margin: 0; font-size: 13px;">üóìÔ∏è Inserir Data</button>
            </div>
            
            <textarea id="texto-observacoes" placeholder="Clique no bot√£o acima para inserir a data de hoje ou digite livremente..."></textarea>
            
            <div class="botoes-rodape">
                <button onclick="salvarObservacao()">Salvar Informa√ß√µes </button>
                <button class="btn-relatorio" onclick="abrirRelatorio()">Gerar Relat√≥rio</button>
                <button class="btn-whatsapp" onclick="enviarWhatsApp()">Enviar no WhatsApp</button>
            </div>
        </div>
    </div>

    <div id="tela-relatorio">
        <div class="no-print botoes-relatorio">
            <button class="btn-voltar-suave" onclick="fecharRelatorio()">Voltar ao Painel</button>
            <button class="btn-imprimir-suave" onclick="window.print()">Imprimir / Salvar PDF</button>
        </div>
        
        <div class="relatorio-cabecalho">
            <h1>Relat√≥rio de Informa√ß√µes Relevantes</h1>
            <p>Paciente: <strong>Arlinda Batista Passos</strong></p>
            <p>Gerado em: <span id="data-geracao-relatorio"></span></p>
        </div>

        <h3>Quadro de Visitas</h3>
        <div class="tabela-wrapper">
            <table class="tabela-relatorio">
                <thead>
                    <tr>
                        <th style="width: 30%;">Dia</th>
                        <th style="width: 70%;">Visitas Agendadas</th>
                    </tr>
                </thead>
                <tbody id="corpo-tabela-relatorio"></tbody>
            </table>
        </div>

        <h3>Informa√ß√µes Relevantes</h3>
        <div class="obs-relatorio" id="obs-relatorio-texto"></div>
    </div>

    <div id="modal-overlay">
        <div class="modal-conteudo">
            <h3 id="modal-titulo">Agendar Hor√°rio</h3>
            
            <div id="lista-visitas-modal" class="lista-visitas-modal">
                </div>
            
            <div class="form-nova-visita">
                <label>‚ûï Adicionar Novo Visitante</label>
                <input type="text" id="novo-nome" placeholder="Nome">
                <div class="linha-horario">
                    Das <input type="text" class="input-hora" id="novo-inicio" placeholder="00:00" maxlength="5" inputmode="numeric" oninput="formatarHora(this)"> 
                    √†s <input type="text" class="input-hora" id="novo-fim" placeholder="00:00" maxlength="5" inputmode="numeric" oninput="formatarHora(this)">
                </div>
                <p class="aviso-regra">‚ö†Ô∏è <strong>Regra:</strong> As Visitas s√£o agendadas com Intervalo de 5 minutos.</p>
                
                <button onclick="adicionarNaListaModal()" style="background-color: #3498db; box-shadow: 0 4px #2980b9; padding: 10px; margin-top: 10px; font-size: 15px; margin-bottom: 0;">Confirmar Hor√°rio</button>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" onclick="fecharModal()">Cancelar (Sair)</button>
                <button class="btn-salvar" onclick="salvarVisitasNuvem()">Salvar Agenda</button>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO DO FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDa7vGvKOKzCAlnIADGUbOtWpr-vZ8iUSY",
            authDomain: "controle-visitas-arlinda.firebaseapp.com",
            databaseURL: "https://controle-visitas-arlinda-default-rtdb.firebaseio.com",
            projectId: "controle-visitas-arlinda",
            storageBucket: "controle-visitas-arlinda.firebasestorage.app",
            messagingSenderId: "542401912473",
            appId: "1:542401912473:web:ad8628ceb4d511d6032208"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();

        let diaEdicao = '';
        let diasAtivos = []; 
        let bancoDeDadosNuvem = {}; 
        let conexaoIniciada = false; 
        let deslocamentoDias = 0; 
        let listaTemporariaModal = []; 

        function inserirDataObs() {
            const textarea = document.getElementById('texto-observacoes');
            const dataHoje = new Date().toLocaleDateString('pt-BR');
            const separador = textarea.value.trim() === '' ? `üóìÔ∏è === ${dataHoje} ===\n` : `\n\nüóìÔ∏è === ${dataHoje} ===\n`;
            textarea.value += separador;
            textarea.focus(); 
        }

        function toggleSenha() {
            const inputSenha = document.getElementById('senha-acesso');
            if (inputSenha.type === 'password') { inputSenha.type = 'text'; } 
            else { inputSenha.type = 'password'; }
        }

        function formatarHora(campo) {
            let valor = campo.value.replace(/\D/g, ''); 
            if (valor.length >= 3) { campo.value = valor.substring(0, 2) + ':' + valor.substring(2, 4); } 
            else { campo.value = valor; }
        }

        function fazerLogin() {
            const nomeDigitado = document.getElementById('nome-visitante').value;
            const senhaDigitada = document.getElementById('senha-acesso').value;
            
            if ((senhaDigitada === '409' || senhaDigitada === '409') && nomeDigitado.trim() !== '') {
                document.getElementById('boas-vindas-texto').innerHTML = `Oi, <strong>${nomeDigitado}</strong> - grato por sua visita!!!`;
                document.getElementById('tela-login').style.display = 'none';
                document.getElementById('tela-painel').style.display = 'block';
                iniciarConexaoNuvem(); 
            } else {
                document.getElementById('mensagem-erro').style.display = 'block';
            }
        }

        function sairDoSistema() {
            document.getElementById('nome-visitante').value = '';
            document.getElementById('senha-acesso').value = '';
            document.getElementById('senha-acesso').type = 'password'; 
            document.getElementById('mensagem-erro').style.display = 'none';
            document.getElementById('tela-painel').style.display = 'none';
            document.getElementById('tela-login').style.display = 'flex';
            
            deslocamentoDias = 0; 
            if (conexaoIniciada) {
                db.ref('visitasDonaArlinda').off();
                db.ref('obsDonaArlinda').off();
                conexaoIniciada = false;
            }
        }

        function mudarSemana(dias) { deslocamentoDias += dias; atualizarPainel(); }
        function irParaHoje() { deslocamentoDias = 0; atualizarPainel(); }

        function iniciarConexaoNuvem() {
            atualizarPainel();
            if (!conexaoIniciada) {
                db.ref('visitasDonaArlinda').on('value', (snapshot) => {
                    bancoDeDadosNuvem = snapshot.val() || {};
                    gerarDiasDaSemana(); 
                }, (erro) => {
                    alert("‚ùå ERRO AO CONECTAR NA NUVEM: " + erro.message);
                });

                db.ref('obsDonaArlinda').on('value', (snapshot) => {
                    document.getElementById('texto-observacoes').value = snapshot.val() || '';
                });
                setInterval(gerarDiasDaSemana, 60000); 
                conexaoIniciada = true;
            }
        }

        function atualizarPainel() { calcularSeteDias(); gerarDiasDaSemana(); }

        function calcularSeteDias() {
            diasAtivos = [];
            const nomesSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            let hojeReal = new Date();
            let stringHojeReal = hojeReal.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});

            for(let i = 0; i < 7; i++) {
                let dataObj = new Date();
                dataObj.setDate(dataObj.getDate() + deslocamentoDias + i); 
                let diaSemanaNome = nomesSemana[dataObj.getDay()];
                let dataFormatada = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                let titulo = (dataFormatada === stringHojeReal) ? 'Hoje' : diaSemanaNome;
                
                let idParaBanco = dataFormatada.replace(/\//g, '-'); 

                diasAtivos.push({ idUnico: idParaBanco, tituloPrincipal: titulo, subTitulo: dataFormatada, objetoData: dataObj });
            }

            if (deslocamentoDias === 0) { document.getElementById('texto-periodo').innerHTML = `<strong>Exibindo:</strong> Hoje e pr√≥ximos 6 dias`; } 
            else if (deslocamentoDias < 0) { document.getElementById('texto-periodo').innerHTML = `<strong>Exibindo:</strong> Passado (${diasAtivos[0].subTitulo} at√© ${diasAtivos[6].subTitulo})`; } 
            else { document.getElementById('texto-periodo').innerHTML = `<strong>Exibindo:</strong> Futuro (${diasAtivos[0].subTitulo} at√© ${diasAtivos[6].subTitulo})`; }
        }

        function converterParaMinutos(horaString) {
            let [h, m] = horaString.split(':').map(Number);
            return h * 60 + m;
        }

        function minutosParaHora(minutosTotal) {
            let h = Math.floor(minutosTotal / 60);
            let m = minutosTotal % 60;
            if (h >= 24) h -= 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function gerarHtmlRetangulosHorario(lista, dataObjeto) {
            if (lista.length === 0) {
                return `
                <div style="margin-top: 10px;">
                    <div class="horario-grupo cor-hora-0" style="text-align: center; color: white;">
                        <div style="font-size: 14px; font-weight: bold; padding: 5px;">Nenhuma Visita üò¢</div>
                    </div>
                </div>`;
            }
            
            let eventos = [];
            lista.forEach(v => {
                let minI = converterParaMinutos(v.inicio);
                let minF = converterParaMinutos(v.fim);
                if (minF <= minI) minF += 24 * 60; 
                
                eventos.push({ time: minI, type: 'start', nome: v.nome });
                eventos.push({ time: minF, type: 'end', nome: v.nome });
            });

            // Ordena√ß√£o para fatiar o tempo (Sweepline)
            eventos.sort((a, b) => {
                if (a.time !== b.time) return a.time - b.time;
                if (a.type === 'end' && b.type === 'start') return -1;
                if (a.type === 'start' && b.type === 'end') return 1;
                return 0;
            });

            let blocos = [];
            let visitantesAtuais = [];
            let tempoAnterior = null;

            eventos.forEach(evento => {
                // Se houver pessoas e o tempo andou, fechamos um bloco
                if (tempoAnterior !== null && evento.time > tempoAnterior && visitantesAtuais.length > 0) {
                    blocos.push({
                        inicio: tempoAnterior,
                        fim: evento.time,
                        nomes: [...visitantesAtuais]
                    });
                }
                
                if (evento.type === 'start') {
                    visitantesAtuais.push(evento.nome);
                } else {
                    let index = visitantesAtuais.indexOf(evento.nome);
                    if (index > -1) visitantesAtuais.splice(index, 1);
                }
                tempoAnterior = evento.time;
            });

            let html = '<div style="margin-top: 10px;">';
            
blocos.forEach(bloco => {
                let qtd = bloco.nomes.length;
                let corClasse = '';
                
                // REGRAS DE CORES: Mantemos a intensidade das cores por quantidade
                if (qtd === 1) {
                    corClasse = 'cor-hora-1'; 
                } else if (qtd === 2) {
                    corClasse = 'cor-hora-2'; 
                } else if (qtd === 3 || qtd === 4) {
                    corClasse = 'cor-hora-3'; 
                } else if (qtd > 4) {
                    corClasse = 'cor-hora-4'; 
                }
                
                // REGRA DAS CARINHAS: Exatamente 1 por visita (at√© o limite de 6)
                // O Math.min garante que se tivermos 10 pessoas, ele vai desenhar no m√°ximo 6 carinhas
                let carinhas = 'üôÇ'.repeat(Math.min(qtd, 6));
                
                let horaI = minutosParaHora(bloco.inicio);
                let horaF = minutosParaHora(bloco.fim);
                
                let expirou = false;
                let [hFim, mFim] = horaF.split(':').map(Number);
                let [hIni, mIni] = horaI.split(':').map(Number);
                let dataHoraFim = new Date(dataObjeto.getTime());
                if (hFim < hIni) dataHoraFim.setDate(dataHoraFim.getDate() + 1);
                dataHoraFim.setHours(hFim, mFim, 0, 0);
                if (new Date() > dataHoraFim) expirou = true;

                let estiloOpacidade = expirou ? 'opacity: 0.5;' : '';

                html += `
                <div class="horario-grupo" style="${estiloOpacidade}">
                    <div class="horario-header ${corClasse}">‚è±Ô∏è ${horaI} √†s ${horaF} ${carinhas}</div>
                    <div class="horario-nomes">
                        ${bloco.nomes.map(nome => expirou ? `‚Ä¢ <s style="color:#7f8c8d;"><strong>${nome}</strong></s>` : `‚Ä¢ <strong>${nome}</strong>`).join('<br>')}
                    </div>
                </div>`;
            });
            
            html += '</div>';
            return html;
        }

        function gerarDiasDaSemana() {
            const gradeDias = document.getElementById('grade-dias');
            if(!gradeDias) return; 
            gradeDias.innerHTML = '';

            diasAtivos.forEach(diaInfo => {
                const divColuna = document.createElement('div');
                divColuna.className = 'dia-coluna';
                const divTitulo = document.createElement('div');
                divTitulo.className = 'dia-titulo';
                
                let corTitulo = diaInfo.tituloPrincipal === 'Hoje' ? 'color: #3498db;' : '';
                divTitulo.innerHTML = `<span style="font-size:14px; font-weight:bold; ${corTitulo}">${diaInfo.tituloPrincipal}</span> <span>${diaInfo.subTitulo}</span>`;

                let listaVisitas = bancoDeDadosNuvem[diaInfo.idUnico] || [];
                let htmlVisitas = gerarHtmlRetangulosHorario(listaVisitas, diaInfo.objetoData);

                const blocoVisitas = document.createElement('div');
                blocoVisitas.className = `turno-bloco turno-unico`;
                blocoVisitas.innerHTML = `Gest√£o do Dia ${htmlVisitas}`;
                blocoVisitas.onclick = () => abrirModal(diaInfo.idUnico, diaInfo.tituloPrincipal);

                divColuna.appendChild(divTitulo);
                divColuna.appendChild(blocoVisitas);
                gradeDias.appendChild(divColuna);
            });
        }

        function abrirModal(idData, nomeExibicao) {
            diaEdicao = idData;
            document.getElementById('modal-titulo').innerText = `${nomeExibicao} (${idData.replace('-', '/')})`;
            
            listaTemporariaModal = [...(bancoDeDadosNuvem[idData] || [])];
            
            document.getElementById('novo-nome').value = '';
            document.getElementById('novo-inicio').value = '';
            document.getElementById('novo-fim').value = '';
            
            atualizarListaNoModal();
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function fecharModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function atualizarListaNoModal() {
            const divLista = document.getElementById('lista-visitas-modal');
            divLista.innerHTML = '';
            
            if (listaTemporariaModal.length === 0) {
                divLista.innerHTML = '<div style="text-align:center; color:#7f8c8d; padding:10px;">Nenhum hor√°rio agendado.</div>';
                return;
            }

            listaTemporariaModal.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));

            listaTemporariaModal.forEach((visita, index) => {
                divLista.innerHTML += `
                <div class="item-visita-modal">
                    <div><strong>${visita.inicio} √†s ${visita.fim}</strong><br><strong>${visita.nome}</strong></div>
                    <button class="btn-apagar-modal" onclick="removerDaListaModal(${index})">üóëÔ∏è Excluir</button>
                </div>`;
            });
        }

        function removerDaListaModal(index) {
            listaTemporariaModal.splice(index, 1);
            atualizarListaNoModal();
        }

        function adicionarNaListaModal() {
            const nome = document.getElementById('novo-nome').value.trim();
            const inicio = document.getElementById('novo-inicio').value;
            const fim = document.getElementById('novo-fim').value;

            if (nome === '' || inicio.length !== 5 || fim.length !== 5) {
                alert("Preencha o nome e o hor√°rio completo (Ex: 14:05)!"); return;
            }

            let [hIni, mIni] = inicio.split(':').map(Number);
            let [hFim, mFim] = fim.split(':').map(Number);

            if (isNaN(hIni) || isNaN(mIni) || isNaN(hFim) || isNaN(mFim) || hIni > 23 || mIni > 59 || hFim > 23 || mFim > 59) {
                alert("Voc√™ digitou um hor√°rio que n√£o existe!"); return;
            }

            if (mIni % 5 !== 0 || mFim % 5 !== 0) {
                alert("Aten√ß√£o: Os hor√°rios devem ser exatos em intervalos de 5 minutos (ex: 14:00, 14:05, 14:15)!"); return;
            }

            let minI = converterParaMinutos(inicio);
            let minF = converterParaMinutos(fim);
            
            if (minF <= minI) minF += 24 * 60; 

            let hojeReal = new Date();
            let stringHojeReal = hojeReal.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'}).replace(/\//g, '-');
            if (diaEdicao === stringHojeReal) {
                let dataAgendamento = new Date(); dataAgendamento.setHours(hIni, mIni, 0, 0);
                if (dataAgendamento < hojeReal) { alert(`Aten√ß√£o: A hora ${inicio} j√° passou!`); return; }
            }

            listaTemporariaModal.push({ nome: nome, inicio: inicio, fim: fim });
            
            document.getElementById('novo-nome').value = '';
            document.getElementById('novo-inicio').value = '';
            document.getElementById('novo-fim').value = '';
            
            atualizarListaNoModal();
        }

        function salvarVisitasNuvem() {
            bancoDeDadosNuvem[diaEdicao] = listaTemporariaModal;
            gerarDiasDaSemana(); 
            
            db.ref('visitasDonaArlinda').set(bancoDeDadosNuvem)
              .then(() => { fecharModal(); })
              .catch((erro) => { alert("‚ùå ERRO AO SALVAR NA NUVEM: " + erro.message); });
        }

        function salvarObservacao() {
            const texto = document.getElementById('texto-observacoes').value;
            db.ref('obsDonaArlinda').set(texto)
              .then(() => { alert('‚úÖ Informa√ß√µes salvas com sucesso!'); })
              .catch((erro) => { alert('‚ùå ERRO AO SALVAR: ' + erro.message); });
        }

        function enviarWhatsApp() {
            let hojeReal = new Date();
            let amanhaReal = new Date(); amanhaReal.setDate(amanhaReal.getDate() + 1);
            
            const hojeVis = hojeReal.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
            const amanhaVis = amanhaReal.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
            
            const hojeId = hojeVis.replace(/\//g, '-');
            const amanhaId = amanhaVis.replace(/\//g, '-');
            
            let texto = `*Agenda de Visitas/Cuidados - Atualiza√ß√£o*\n\n`;
            
            texto += `üìÖ *HOJE (${hojeVis})*\n`;
            let hojeVisitas = bancoDeDadosNuvem[hojeId] || [];
            hojeVisitas.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            
            if(hojeVisitas.length > 0) { hojeVisitas.forEach(v => texto += `- ${v.inicio} √†s ${v.fim}: *${v.nome}*\n`); } else { texto += `Livre\n`; }

            texto += `\nüìÖ *AMANH√É (${amanhaVis})*\n`;
            let amaVisitas = bancoDeDadosNuvem[amanhaId] || [];
            amaVisitas.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            
            if(amaVisitas.length > 0) { amaVisitas.forEach(v => texto += `- ${v.inicio} √†s ${v.fim}: *${v.nome}*\n`); } else { texto += `Livre\n`; }

            let url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
            window.open(url, '_blank');
        }

        function abrirRelatorio() {
            try {
                const corpoTabela = document.getElementById('corpo-tabela-relatorio');
                corpoTabela.innerHTML = '';
                document.getElementById('data-geracao-relatorio').innerText = new Date().toLocaleString('pt-BR');

                diasAtivos.forEach(diaInfo => {
                    let listaVisitas = bancoDeDadosNuvem[diaInfo.idUnico] || [];
                    listaVisitas.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
                    
                    let textoVisitas = listaVisitas.length === 0 ? '<i>Livre üò¢</i>' : listaVisitas.map(v => `‚Ä¢ <strong>${v.inicio} √†s ${v.fim}</strong>: <strong>${v.nome}</strong>`).join('<br><br>');
                    
                    const linha = `<tr><td><strong>${diaInfo.tituloPrincipal}</strong><br><span style="font-size:12px;color:#7f8c8d;">${diaInfo.subTitulo}</span></td><td>${textoVisitas}</td></tr>`;
                    corpoTabela.innerHTML += linha;
                });

                document.getElementById('obs-relatorio-texto').innerHTML = document.getElementById('texto-observacoes').value.replace(/\n/g, '<br>') || 'Nenhuma informa√ß√£o registrada.';
                document.getElementById('tela-painel').style.display = 'none';
                document.getElementById('tela-relatorio').style.display = 'block';
            } catch (erro) { alert("Ocorreu um erro ao montar o relat√≥rio: " + erro.message); }
        }

        function fecharRelatorio() {
            document.getElementById('tela-relatorio').style.display = 'none';
            document.getElementById('tela-painel').style.display = 'block';
        }
    </script>

    <script>
        // Registrando o Service Worker para virar App
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('App registrado com sucesso!', reg))
                .catch(err => console.log('Falha ao registrar App', err));
            });
        }
    </script>
</body>
</html>
