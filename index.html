<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Visitas - Arlinda Batista Passos</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icone-192.png">
    <meta name="theme-color" content="#3498db">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script> 

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e2e8f0; min-height: 100vh; display: flex; flex-direction: column; }

        /* TELA DE LOGIN */
        #tela-login { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100%; padding: 20px; }
        .cartao-login { background-color: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        .cartao-login h2 { color: #2c3e50; margin-bottom: 5px; }
        .cartao-login p { color: #7f8c8d; margin-bottom: 25px; font-size: 14px; }
        
        .input-grupo { margin-bottom: 15px; position: relative; }
        .input-grupo input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #senha-acesso { padding-right: 45px; }
        .olhinho { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; user-select: none; }
        
        button { width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #3498db; box-shadow: 0 5px #2980b9; transition: all 0.1s; margin-bottom: 10px; }
        button:active { box-shadow: 0 2px #2980b9; transform: translateY(3px); }
        #mensagem-erro { color: #e74c3c; margin-top: 15px; display: none; font-weight: bold; }

        /* TELA DO PAINEL */
        #tela-painel { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        /* Cabe√ßalho */
        .cabecalho-paciente { display: flex; align-items: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; flex-wrap: wrap; }
        .foto-container { width: 90px; height: 90px; border-radius: 50%; overflow: hidden; border: 4px solid #3498db; margin-right: 20px; background-color: #ecf0f1; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .foto-paciente { width: 100%; height: 100%; object-fit: cover; }
        .info-paciente { flex-grow: 1; }
        .info-paciente h2 { color: #2c3e50; font-size: 24px; }
        .info-paciente p { color: #7f8c8d; font-size: 16px; margin-top: 5px; }
        .mensagem-boas-vindas { color: #27ae60; font-size: 15px; margin-top: 8px !important; }
        
        .btn-sair { background-color: #e74c3c; box-shadow: 0 5px #c0392b; width: auto; padding: 10px 25px; margin-bottom: 0; margin-left: auto;}
        
        /* Containers e Cart√µes Brancos */
        .cartao-branco { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .cartao-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #2c3e50; flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;}
        .cartao-header h3 { display: flex; align-items: center; gap: 8px; }

        /* Grade Semanal */
        .navegacao-semana { display: flex; gap: 10px; align-items: center; }
        .btn-nav { background-color: #ecf0f1; color: #2c3e50; box-shadow: 0 4px #bdc3c7; padding: 8px 15px; font-size: 14px; width: auto; margin: 0; }
        .btn-hoje { background-color: #34495e; color: white; box-shadow: 0 4px #2c3e50; }
        
        .grade-dias { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .dia-coluna { display: flex; flex-direction: column; gap: 10px; }
        .dia-titulo { text-align: center; font-weight: bold; color: #34495e; padding-bottom: 5px; border-bottom: 2px solid #ecf0f1; font-size: 14px; }
        .dia-titulo span { display: block; font-size: 12px; color: #7f8c8d; font-weight: normal; }
        
        .turno-bloco { padding: 15px 10px; border-radius: 8px; text-align: center; font-weight: bold; color: white; cursor: pointer; font-size: 14px; box-shadow: 0 5px rgba(0,0,0,0.3); transition: all 0.1s; min-height: 120px; }
        .turno-bloco:active { box-shadow: 0 2px rgba(0,0,0,0.3); transform: translateY(3px); }
        .turno-unico { background-color: #34495e; border: 2px solid #2c3e50; } 

        .horario-grupo { background: rgba(255, 255, 255, 0.95); border-radius: 6px; padding: 6px; margin-bottom: 10px; text-align: left; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .horario-header { font-size: 12px; font-weight: bold; padding: 5px; border-radius: 4px; color: white; text-align: center; margin-bottom: 6px; }
        .horario-nomes { font-size: 13px; line-height: 1.5; color: #2c3e50; font-weight: normal; padding-left: 5px; }
        
        .cor-hora-0 { background-color: #95a5a6; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-1 { background-color: #2ecc71; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-2 { background-color: #f1c40f; color: #2c3e50 !important; } 
        .cor-hora-3 { background-color: #e67e22; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-4 { background-color: #e74c3c; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-2 { color: #2c3e50; } 

        /* Observa√ß√µes */
        textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; resize: none; font-family: inherit; margin-bottom: 15px; line-height: 1.5; }
        .botoes-rodape { display: flex; gap: 10px; flex-wrap: wrap; }
        .botoes-rodape button { flex: 1; margin-bottom: 0; min-width: 150px; } 

        /* GRAVA√á√ÉO DE √ÅUDIO & MIDIA */
        .btn-gravar { background-color: #e74c3c; box-shadow: 0 5px #c0392b; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-gravar.gravando { background-color: #c0392b; animation: piscar 1.5s infinite; }
        @keyframes piscar { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        
        .lista-audios { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .item-audio { background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; }
        .item-audio-header { display: flex; justify-content: space-between; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; }
        .item-audio-header span.nome { color: #2980b9; }
        audio { width: 100%; height: 35px; outline: none; }

        /* GALERIA DE FOTOS */
        .btn-foto { background-color: #9b59b6; box-shadow: 0 5px #8e44ad; }
        .grade-fotos { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .cartao-foto { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid #ecf0f1; background: #000; }
        .cartao-foto img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .legenda-foto { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; font-size: 11px; padding: 5px; text-align: center; }

        /* MODAL E RELAT√ìRIO (Ocultos no padr√£o) */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; padding: 10px; }
        .modal-conteudo { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .linha-horario { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #34495e; margin-bottom: 10px;}
        .linha-horario input[type="text"].input-hora { padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 15px; flex: 1; text-align: center; font-weight: bold; color: #2c3e50;}
        .form-nova-visita input[type="text"] { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; margin-bottom: 10px; margin-top: 5px; }
        .modal-botoes { display: flex; gap: 10px; margin-top: 20px; }
        
        .item-visita-modal { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed #ccc; font-size: 14px; color: #34495e; }
        .btn-apagar-modal { background: #fadbd8; color: #c0392b; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; box-shadow: none; width: auto; margin: 0; }

        #tela-relatorio { display: none; padding: 40px; background: white; width: 98%; max-width: 1400px; margin: 20px auto; border-radius: 12px; }
        .tabela-relatorio { width: 100%; border-collapse: collapse; margin-top: 20px;}
        .tabela-relatorio th, .tabela-relatorio td { border: 1px solid #bdc3c7; padding: 10px; text-align: left;}

        @media (max-width: 768px) {
            .grade-dias { grid-template-columns: 1fr; }
            .botoes-rodape { flex-direction: column; }
            .botoes-rodape button { width: 100%; }
            .cartao-header { flex-direction: column; text-align: center; }
        }
        
        @media print {
            body { background: white; }
            .no-print, #tela-painel, #tela-login { display: none !important; }
            #tela-relatorio { display: block !important; width: 100% !important; margin: 0 !important; padding: 0 !important;}
        }
    </style>
</head>
<body>

    <div id="tela-login">
        <div class="cartao-login">
            <h2>Controle de Visitas</h2>
            <p>Paciente: Arlinda Batista Passos</p>
            <div class="input-grupo"><input type="text" id="nome-visitante" placeholder="Seu Nome (Visitante/Cuidador)" required></div>
            <div class="input-grupo">
                <input type="password" id="senha-acesso" placeholder="Senha de Acesso" required>
                <span class="olhinho" onclick="toggleSenha()">üëÅÔ∏è</span>
            </div>
            <button onclick="fazerLogin()">Entrar</button>
            <p id="mensagem-erro">Senha incorreta ou nome em branco!</p>
        </div>
    </div>

    <div id="tela-painel">
        <div class="cabecalho-paciente cartao-branco">
            <div class="foto-container">
                <img src="mae.jpg" alt="Foto Dona Arlinda" class="foto-paciente" onerror="this.src='https://via.placeholder.com/90?text=Sem+Foto'">
            </div>
            <div class="info-paciente">
                <h2>Arlinda Batista Passos</h2>
                <p><strong>Rua:</strong> √Ågua Marinha, 409</p>
                <p id="boas-vindas-texto" class="mensagem-boas-vindas"></p>
            </div>
            <button class="btn-sair" onclick="sairDoSistema()">Sair</button>
        </div>

        <div class="cartao-branco">
            <div class="cartao-header">
                <h3>üóìÔ∏è Agenda de Visitas/Cuidados</h3>
                <div class="navegacao-semana">
                    <button class="btn-nav" onclick="mudarSemana(-7)">‚¨ÖÔ∏è Ant.</button>
                    <button class="btn-nav btn-hoje" onclick="irParaHoje()">Hoje</button>
                    <button class="btn-nav" onclick="mudarSemana(7)">Pr√≥x. ‚û°Ô∏è</button>
                </div>
            </div>
            <div class="grade-dias" id="grade-dias"></div>
        </div>

        <div class="cartao-branco">
            <div class="cartao-header" style="border-bottom:none; margin-bottom: 5px;">
                <h3>ü©∫ Informa√ß√µes Relevantes</h3>
                <button onclick="inserirDataObs()" style="background-color: #f39c12; box-shadow: 0 4px #e67e22; width: auto; padding: 6px 15px; margin: 0; font-size: 13px;">üóìÔ∏è Inserir Data Texto</button>
            </div>
            <textarea id="texto-observacoes" placeholder="Digite informa√ß√µes m√©dicas, dieta, estado geral..."></textarea>
            
            <div class="botoes-rodape" style="margin-bottom: 15px;">
                <button onclick="salvarObservacao()" style="background-color: #2ecc71; box-shadow: 0 5px #27ae60;">üíæ Salvar Texto</button>
                <button id="btn-gravar-info" class="btn-gravar" onclick="alternarGravacao('info')">üé§ Gravar √Åudio M√©dico</button>
            </div>
            
            <div id="lista-audios-info" class="lista-audios"></div>
            
            <div class="botoes-rodape" style="margin-top: 20px; border-top: 1px solid #ecf0f1; padding-top: 15px;">
                <button style="background-color: #9b59b6; box-shadow: 0 5px #8e44ad;" onclick="abrirRelatorio()">Gerar Relat√≥rio</button>
                <button style="background-color: #25D366; box-shadow: 0 5px #128C7E;" onclick="enviarWhatsApp()">Enviar WhatsApp</button>
            </div>
        </div>

        <div class="cartao-branco" style="border: 2px solid #fd79a8; background: #fff0f6;">
            <div class="cartao-header" style="border-color: #fab1a0;">
                <h3 style="color: #d63031;">üíå Recadinhos Fofos de Amor</h3>
                <p style="font-size: 13px; color: #e17055;">Deixe uma mensagem de voz carinhosa para ela ouvir!</p>
            </div>
            <button id="btn-gravar-recado" class="btn-gravar" style="background-color: #fd79a8; box-shadow: 0 5px #e84393;" onclick="alternarGravacao('recadinho')">üíñ Gravar Novo Recadinho</button>
            <div id="lista-audios-recadinhos" class="lista-audios"></div>
        </div>

        <div class="cartao-branco">
            <div class="cartao-header">
                <h3>üì∏ Mural de Momentos Lindos</h3>
                <p style="font-size: 13px; color: #7f8c8d;">Registre e eternize as visitas!</p>
            </div>
            <input type="file" id="input-foto" accept="image/*" style="display:none" onchange="subirFotoGaleria(event)">
            <button class="btn-foto" onclick="document.getElementById('input-foto').click()">üì∑ Tirar Foto ou Escolher da Galeria</button>
            <div id="grade-fotos" class="grade-fotos"></div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-conteudo">
            <h3 id="modal-titulo">Agendar Hor√°rio</h3>
            <div id="lista-visitas-modal" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto;"></div>
            <div style="background: #eaf2f8; padding: 15px; border-radius: 8px; border: 1px solid #d4e6f1;">
                <label style="font-size: 13px; font-weight: bold; color: #2980b9;">‚ûï Adicionar Novo Visitante</label>
                <input type="text" id="novo-nome" placeholder="Nome">
                <div class="linha-horario">
                    Das <input type="text" class="input-hora" id="novo-inicio" placeholder="00:00" maxlength="5" inputmode="numeric" oninput="formatarHora(this)"> 
                    √†s <input type="text" class="input-hora" id="novo-fim" placeholder="00:00" maxlength="5" inputmode="numeric" oninput="formatarHora(this)">
                </div>
                <button onclick="adicionarNaListaModal()" style="background-color: #3498db; width:100%; padding:10px; color:white; border:none; border-radius:5px; font-weight:bold;">Confirmar Hor√°rio</button>
            </div>
            <div class="modal-botoes">
                <button onclick="fecharModal()" style="background-color: #95a5a6; flex:1; padding:10px; color:white; border:none; border-radius:5px;">Sair</button>
                <button onclick="salvarVisitasNuvem()" style="background-color: #2ecc71; flex:1; padding:10px; color:white; border:none; border-radius:5px;">Salvar Agenda</button>
            </div>
        </div>
    </div>

    <div id="tela-relatorio">
        <div class="no-print" style="display: flex; gap:10px; margin-bottom: 20px;">
            <button onclick="fecharRelatorio()" style="background-color: #a29bfe; padding:10px; color:white; border:none; border-radius:5px; flex:1;">Voltar</button>
            <button onclick="window.print()" style="background-color: #74b9ff; padding:10px; color:white; border:none; border-radius:5px; flex:1;">Imprimir</button>
        </div>
        <h2 style="text-align:center; color:#2c3e50;">Relat√≥rio de Visitas</h2>
        <table class="tabela-relatorio">
            <thead><tr><th>Dia</th><th>Visitas</th></tr></thead>
            <tbody id="corpo-tabela-relatorio"></tbody>
        </table>
        <h3 style="margin-top:20px;">Informa√ß√µes Relevantes</h3>
        <div id="obs-relatorio-texto" style="background:#f9f9f9; padding:15px; border-left:4px solid #3498db;"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO DO FIREBASE (Database + Storage)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDa7vGvKOKzCAlnIADGUbOtWpr-vZ8iUSY",
            authDomain: "controle-visitas-arlinda.firebaseapp.com",
            databaseURL: "https://controle-visitas-arlinda-default-rtdb.firebaseio.com",
            projectId: "controle-visitas-arlinda",
            storageBucket: "controle-visitas-arlinda.firebasestorage.app",
            messagingSenderId: "542401912473",
            appId: "1:542401912473:web:ad8628ceb4d511d6032208"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const storage = firebase.storage();

        // Vari√°veis Globais
        let usuarioLogado = '';
        let diaEdicao = '';
        let diasAtivos = []; 
        let bancoDeDadosNuvem = {}; 
        let conexaoIniciada = false; 
        let deslocamentoDias = 0; 
        let listaTemporariaModal = []; 

        // Vari√°veis do Gravador de √Åudio
        let mediaRecorder;
        let audioChunks = [];
        let estadoGravacao = { info: false, recadinho: false };

        // ==========================================
        // LOGIN E CONEX√ÉO
        // ==========================================
        function toggleSenha() {
            const input = document.getElementById('senha-acesso');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function fazerLogin() {
            const nomeDigitado = document.getElementById('nome-visitante').value.trim();
            const senhaDigitada = document.getElementById('senha-acesso').value;
            
            if ((senhaDigitada === '409' || senhaDigitada === '409') && nomeDigitado !== '') {
                usuarioLogado = nomeDigitado;
                document.getElementById('boas-vindas-texto').innerHTML = `Logado como: <strong>${usuarioLogado}</strong>`;
                document.getElementById('tela-login').style.display = 'none';
                document.getElementById('tela-painel').style.display = 'block';
                iniciarConexaoNuvem(); 
            } else {
                document.getElementById('mensagem-erro').style.display = 'block';
            }
        }

        function sairDoSistema() {
            window.location.reload(); // Recarrega para limpar tudo da mem√≥ria por seguran√ßa
        }

        function iniciarConexaoNuvem() {
            atualizarPainel();
            if (!conexaoIniciada) {
                // Agenda
                db.ref('visitasDonaArlinda').on('value', (snapshot) => {
                    bancoDeDadosNuvem = snapshot.val() || {};
                    gerarDiasDaSemana(); 
                });
                // Texto Info
                db.ref('obsDonaArlinda').on('value', (snapshot) => {
                    document.getElementById('texto-observacoes').value = snapshot.val() || '';
                });
                // √Åudios Info
                db.ref('audiosInfo').on('value', (snapshot) => {
                    renderizarAudios(snapshot.val(), 'lista-audios-info');
                });
                // Recadinhos
                db.ref('recadinhosFofos').on('value', (snapshot) => {
                    renderizarAudios(snapshot.val(), 'lista-audios-recadinhos', true);
                });
                // Fotos
                db.ref('muralFotos').on('value', (snapshot) => {
                    renderizarFotos(snapshot.val());
                });

                setInterval(gerarDiasDaSemana, 60000); 
                conexaoIniciada = true;
            }
        }

        // ==========================================
        // AGENDA (Tempo, Fatiamento e Modal)
        // ==========================================
        function mudarSemana(dias) { deslocamentoDias += dias; atualizarPainel(); }
        function irParaHoje() { deslocamentoDias = 0; atualizarPainel(); }

        function atualizarPainel() {
            diasAtivos = [];
            const nomesSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            let hojeReal = new Date();
            let stringHojeReal = hojeReal.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});

            for(let i = 0; i < 7; i++) {
                let dataObj = new Date();
                dataObj.setDate(dataObj.getDate() + deslocamentoDias + i); 
                let dataFormatada = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                diasAtivos.push({ 
                    idUnico: dataFormatada.replace(/\//g, '-'), 
                    tituloPrincipal: (dataFormatada === stringHojeReal) ? 'Hoje' : nomesSemana[dataObj.getDay()], 
                    subTitulo: dataFormatada, 
                    objetoData: dataObj 
                });
            }
            gerarDiasDaSemana();
        }

        function converterParaMinutos(horaString) {
            let [h, m] = horaString.split(':').map(Number);
            return h * 60 + m;
        }

        function minutosParaHora(minutosTotal) {
            let h = Math.floor(minutosTotal / 60);
            let m = minutosTotal % 60;
            if (h >= 24) h -= 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function formatarHora(campo) {
            let valor = campo.value.replace(/\D/g, ''); 
            if (valor.length >= 3) { campo.value = valor.substring(0, 2) + ':' + valor.substring(2, 4); } 
            else { campo.value = valor; }
        }

        function gerarDiasDaSemana() {
            const gradeDias = document.getElementById('grade-dias');
            if(!gradeDias) return; 
            gradeDias.innerHTML = '';

            diasAtivos.forEach(diaInfo => {
                let listaVisitas = bancoDeDadosNuvem[diaInfo.idUnico] || [];
                let htmlVisitas = '<div style="margin-top: 10px;">';
                
                if (listaVisitas.length === 0) {
                    htmlVisitas += `<div class="horario-grupo cor-hora-0"><div style="text-align: center; color: white; padding: 5px; font-weight:bold;">Nenhuma Visita üò¢</div></div>`;
                } else {
                    let eventos = [];
                    listaVisitas.forEach(v => {
                        let minI = converterParaMinutos(v.inicio);
                        let minF = converterParaMinutos(v.fim);
                        if (minF <= minI) minF += 24 * 60; 
                        eventos.push({ time: minI, type: 'start', nome: v.nome });
                        eventos.push({ time: minF, type: 'end', nome: v.nome });
                    });
                    eventos.sort((a, b) => a.time !== b.time ? a.time - b.time : (a.type === 'end' ? -1 : 1));

                    let blocos = [], visitantesAtuais = [], tempoAnterior = null;
                    eventos.forEach(evento => {
                        if (tempoAnterior !== null && evento.time > tempoAnterior && visitantesAtuais.length > 0) {
                            blocos.push({ inicio: tempoAnterior, fim: evento.time, nomes: [...visitantesAtuais] });
                        }
                        if (evento.type === 'start') visitantesAtuais.push(evento.nome);
                        else visitantesAtuais.splice(visitantesAtuais.indexOf(evento.nome), 1);
                        tempoAnterior = evento.time;
                    });

                    blocos.forEach(bloco => {
                        let qtd = bloco.nomes.length;
                        let corClasse = qtd === 1 ? 'cor-hora-1' : (qtd === 2 ? 'cor-hora-2' : (qtd <= 4 ? 'cor-hora-3' : 'cor-hora-4'));
                        let carinhas = 'üôÇ'.repeat(Math.min(qtd, 6));
                        
                        let horaI = minutosParaHora(bloco.inicio);
                        let horaF = minutosParaHora(bloco.fim);
                        
                        // Verificador de expira√ß√£o
                        let expirou = false;
                        let [hFim, mFim] = horaF.split(':').map(Number);
                        let dataHoraFim = new Date(diaInfo.objetoData.getTime());
                        dataHoraFim.setHours(hFim, mFim, 0, 0);
                        if (new Date() > dataHoraFim) expirou = true;

                        htmlVisitas += `
                        <div class="horario-grupo" style="${expirou ? 'opacity: 0.5;' : ''}">
                            <div class="horario-header ${corClasse}">‚è±Ô∏è ${horaI} √†s ${horaF} ${carinhas}</div>
                            <div class="horario-nomes">
                                ${bloco.nomes.map(nome => expirou ? `‚Ä¢ <s style="color:#7f8c8d;"><strong>${nome}</strong></s>` : `‚Ä¢ <strong>${nome}</strong>`).join('<br>')}
                            </div>
                        </div>`;
                    });
                }
                htmlVisitas += '</div>';

                const divColuna = document.createElement('div');
                divColuna.className = 'dia-coluna';
                divColuna.innerHTML = `
                    <div class="dia-titulo"><span style="font-size:14px; font-weight:bold; ${diaInfo.tituloPrincipal === 'Hoje' ? 'color:#3498db;' : ''}">${diaInfo.tituloPrincipal}</span> <span>${diaInfo.subTitulo}</span></div>
                    <div class="turno-bloco turno-unico" onclick="abrirModal('${diaInfo.idUnico}', '${diaInfo.tituloPrincipal}')">Gest√£o do Dia ${htmlVisitas}</div>
                `;
                gradeDias.appendChild(divColuna);
            });
        }

        function abrirModal(idData, nomeExibicao) {
            diaEdicao = idData;
            document.getElementById('modal-titulo').innerText = `${nomeExibicao} (${idData.replace('-', '/')})`;
            listaTemporariaModal = [...(bancoDeDadosNuvem[idData] || [])];
            document.getElementById('novo-nome').value = ''; document.getElementById('novo-inicio').value = ''; document.getElementById('novo-fim').value = '';
            atualizarListaNoModal();
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function fecharModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function atualizarListaNoModal() {
            const divLista = document.getElementById('lista-visitas-modal');
            divLista.innerHTML = '';
            if (listaTemporariaModal.length === 0) {
                divLista.innerHTML = '<div style="text-align:center; color:#7f8c8d; padding:10px;">Nenhum hor√°rio agendado.</div>';
                return;
            }
            listaTemporariaModal.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            listaTemporariaModal.forEach((visita, index) => {
                divLista.innerHTML += `
                <div class="item-visita-modal">
                    <div><strong>${visita.inicio} √†s ${visita.fim}</strong><br><strong>${visita.nome}</strong></div>
                    <button class="btn-apagar-modal" onclick="listaTemporariaModal.splice(${index}, 1); atualizarListaNoModal();">üóëÔ∏è Excluir</button>
                </div>`;
            });
        }

        function adicionarNaListaModal() {
            const nome = document.getElementById('novo-nome').value.trim();
            const inicio = document.getElementById('novo-inicio').value;
            const fim = document.getElementById('novo-fim').value;

            if (nome === '' || inicio.length !== 5 || fim.length !== 5) { alert("Preencha o nome e o hor√°rio completo (Ex: 14:05)!"); return; }
            let [hIni, mIni] = inicio.split(':').map(Number); let [hFim, mFim] = fim.split(':').map(Number);
            if (isNaN(hIni) || isNaN(mIni) || isNaN(hFim) || isNaN(mFim) || hIni > 23 || mIni > 59 || hFim > 23 || mFim > 59) { alert("Hor√°rio inv√°lido!"); return; }
            if (mIni % 5 !== 0 || mFim % 5 !== 0) { alert("Apenas intervalos exatos de 5 minutos!"); return; }

            listaTemporariaModal.push({ nome: nome, inicio: inicio, fim: fim });
            document.getElementById('novo-nome').value = ''; document.getElementById('novo-inicio').value = ''; document.getElementById('novo-fim').value = '';
            atualizarListaNoModal();
        }

        function salvarVisitasNuvem() {
            bancoDeDadosNuvem[diaEdicao] = listaTemporariaModal;
            db.ref('visitasDonaArlinda').set(bancoDeDadosNuvem).then(() => fecharModal()).catch(e => alert("Erro: " + e.message));
        }

        // ==========================================
        // TEXTO E WHATSAPP
        // ==========================================
        function inserirDataObs() {
            const t = document.getElementById('texto-observacoes');
            t.value += (t.value.trim() === '' ? '' : '\n\n') + `üóìÔ∏è === ${new Date().toLocaleDateString('pt-BR')} ===\n`;
            t.focus(); 
        }

        function salvarObservacao() {
            db.ref('obsDonaArlinda').set(document.getElementById('texto-observacoes').value)
              .then(() => alert('‚úÖ Informa√ß√µes salvas com sucesso!'))
              .catch(e => alert('Erro: ' + e.message));
        }

        function enviarWhatsApp() {
            let hoje = new Date().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            let ama = new Date(new Date().setDate(new Date().getDate() + 1)).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            
            let hVis = bancoDeDadosNuvem[hoje.replace(/\//g, '-')] || []; hVis.sort((a,b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            let aVis = bancoDeDadosNuvem[ama.replace(/\//g, '-')] || []; aVis.sort((a,b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            
            let txt = `*Agenda Dona Arlinda*\n\nüìÖ *HOJE (${hoje})*\n`;
            txt += hVis.length ? hVis.map(v => `- ${v.inicio} √†s ${v.fim}: *${v.nome}*`).join('\n') : 'Livre';
            txt += `\n\nüìÖ *AMANH√É (${ama})*\n`;
            txt += aVis.length ? aVis.map(v => `- ${v.inicio} √†s ${v.fim}: *${v.nome}*`).join('\n') : 'Livre';

            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }

        // ==========================================
        // √ÅUDIO - GRAVA√á√ÉO E UPLOAD
        // ==========================================
        async function alternarGravacao(tipo) {
            const btnId = tipo === 'info' ? 'btn-gravar-info' : 'btn-gravar-recado';
            const btn = document.getElementById(btnId);
            const dbPath = tipo === 'info' ? 'audiosInfo' : 'recadinhosFofos';

            if (!estadoGravacao[tipo]) {
                // INICIAR GRAVA√á√ÉO
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
                    
                    mediaRecorder.onstop = async () => {
                        btn.innerHTML = '‚è≥ Enviando...';
                        btn.classList.remove('gravando');
                        btn.disabled = true;

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const nomeArquivo = `${Date.now()}_${usuarioLogado.replace(/[^a-zA-Z0-9]/g, '')}.webm`;
                        const pasta = tipo === 'info' ? 'audios_info' : 'audios_recados';
                        
                        try {
                            const snapshot = await storage.ref(`${pasta}/${nomeArquivo}`).put(audioBlob);
                            const downloadURL = await snapshot.ref.getDownloadURL();
                            
                            // Salva no Database
                            await db.ref(dbPath).push({
                                nome: usuarioLogado,
                                url: downloadURL,
                                data: new Date().toLocaleString('pt-BR')
                            });
                            
                            btn.innerHTML = tipo === 'info' ? 'üé§ Gravar √Åudio M√©dico' : 'üíñ Gravar Novo Recadinho';
                            btn.disabled = false;
                        } catch (error) {
                            alert("Erro ao enviar √°udio: " + error.message);
                            btn.innerHTML = tipo === 'info' ? 'üé§ Gravar √Åudio M√©dico' : 'üíñ Gravar Novo Recadinho';
                            btn.disabled = false;
                        }
                    };

                    mediaRecorder.start();
                    estadoGravacao[tipo] = true;
                    btn.innerHTML = '‚èπÔ∏è Parar e Enviar √Åudio';
                    btn.classList.add('gravando');

                } catch (err) { alert("Erro ao acessar microfone. Verifique as permiss√µes do navegador."); }
            } else {
                // PARAR GRAVA√á√ÉO
                mediaRecorder.stop();
                estadoGravacao[tipo] = false;
            }
        }

        function renderizarAudios(dados, containerId, fofo = false) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!dados) return;

            // Converter objeto em array para ordenar pelo mais recente
            let audios = Object.keys(dados).map(k => dados[k]);
            audios.sort((a, b) => {
                let da = a.data.split(' ')[0].split('/').reverse().join('') + a.data.split(' ')[1];
                let db = b.data.split(' ')[0].split('/').reverse().join('') + b.data.split(' ')[1];
                return db.localeCompare(da);
            });

            audios.forEach(aud => {
                let corNome = fofo ? '#e84393' : '#2980b9';
                let icone = fofo ? 'üíå' : 'ü©∫';
                container.innerHTML += `
                <div class="item-audio">
                    <div class="item-audio-header">
                        <span class="nome">${icone} ${fofo ? 'De:' : 'Por:'} <strong>${aud.nome}</strong></span>
                        <span>${aud.data}</span>
                    </div>
                    <audio controls src="${aud.url}"></audio>
                </div>`;
            });
        }

        // ==========================================
        // FOTOS - UPLOAD E GALERIA
        // ==========================================
        async function subirFotoGaleria(event) {
            const file = event.target.files[0];
            if (!file) return;

            const nomeArquivo = `${Date.now()}_${usuarioLogado.replace(/[^a-zA-Z0-9]/g, '')}.jpg`;
            
            // Bot√£o indicando upload
            const divLoad = document.createElement('div');
            divLoad.innerHTML = "<em>Enviando foto... ‚è≥</em>";
            document.getElementById('grade-fotos').prepend(divLoad);

            try {
                const snapshot = await storage.ref(`fotos/${nomeArquivo}`).put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();
                
                await db.ref('muralFotos').push({
                    nome: usuarioLogado,
                    url: downloadURL,
                    data: new Date().toLocaleDateString('pt-BR')
                });
            } catch (error) {
                alert("Erro ao enviar foto: " + error.message);
            }
            event.target.value = ''; // reseta o input
        }

        function renderizarFotos(dados) {
            const container = document.getElementById('grade-fotos');
            container.innerHTML = '';
            if (!dados) {
                container.innerHTML = '<p style="color:#7f8c8d; font-size:13px; grid-column: 1 / -1; text-align:center;">Ainda n√£o h√° fotos. Seja o primeiro a registrar um momento!</p>';
                return;
            }

            let fotos = Object.keys(dados).map(k => dados[k]).reverse(); // Mais novas primeiro

            fotos.forEach(foto => {
                container.innerHTML += `
                <div class="cartao-foto">
                    <a href="${foto.url}" target="_blank">
                        <img src="${foto.url}" alt="Foto com a Dona Arlinda">
                    </a>
                    <div class="legenda-foto">üì∏ ${foto.nome}<br>${foto.data}</div>
                </div>`;
            });
        }

        // ==========================================
        // RELAT√ìRIO
        // ==========================================
        function abrirRelatorio() {
            const corpo = document.getElementById('corpo-tabela-relatorio');
            corpo.innerHTML = '';
            diasAtivos.forEach(dia => {
                let lista = bancoDeDadosNuvem[dia.idUnico] || [];
                lista.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
                let txt = lista.length === 0 ? 'Livre' : lista.map(v => `${v.inicio}-${v.fim}: <strong>${v.nome}</strong>`).join('<br>');
                corpo.innerHTML += `<tr><td><strong>${dia.tituloPrincipal}</strong><br><span style="font-size:12px">${dia.subTitulo}</span></td><td>${txt}</td></tr>`;
            });
            document.getElementById('obs-relatorio-texto').innerHTML = document.getElementById('texto-observacoes').value.replace(/\n/g, '<br>');
            document.getElementById('tela-painel').style.display = 'none';
            document.getElementById('tela-relatorio').style.display = 'block';
        }

        function fecharRelatorio() {
            document.getElementById('tela-relatorio').style.display = 'none';
            document.getElementById('tela-painel').style.display = 'block';
        }

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }
    </script>
</body>
</html>
