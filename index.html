<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Aplicativo da Dindinha!!!</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icone-192.png">
    <meta name="theme-color" content="#3498db">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-storage.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #e2e8f0; min-height: 100vh; display: flex; flex-direction: column; }

        /* TELA DE LOGIN */
        #tela-login { display: flex; align-items: center; justify-content: center; height: 100vh; width: 100%; padding: 20px; }
        .cartao-login { background-color: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); text-align: center; width: 100%; max-width: 400px; }
        .cartao-login h2 { color: #2c3e50; margin-bottom: 5px; }
        .cartao-login p { color: #7f8c8d; margin-bottom: 25px; font-size: 14px; }
        
        .input-grupo { margin-bottom: 15px; position: relative; }
        .input-grupo input { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; }
        #senha-acesso { padding-right: 45px; }
        .olhinho { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; font-size: 20px; user-select: none; }
        
        button { width: 100%; padding: 12px; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; background-color: #3498db; box-shadow: 0 5px #2980b9; transition: all 0.1s; margin-bottom: 10px; }
        button:active { box-shadow: 0 2px #2980b9; transform: translateY(3px); }
        #mensagem-erro { color: #e74c3c; margin-top: 15px; display: none; font-weight: bold; }

        /* TELA DO PAINEL */
        #tela-painel { display: none; padding: 20px; max-width: 1200px; margin: 0 auto; width: 100%; }
        
        /* Cabe√ßalho */
        .cabecalho-paciente { display: flex; align-items: center; background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; flex-wrap: wrap; }
        .foto-container { width: 90px; height: 90px; border-radius: 50%; overflow: hidden; border: 4px solid #3498db; margin-right: 20px; background-color: #ecf0f1; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .foto-paciente { width: 100%; height: 100%; object-fit: cover; }
        .info-paciente { flex-grow: 1; }
        .info-paciente h2 { color: #2c3e50; font-size: 24px; }
        .info-paciente p { color: #7f8c8d; font-size: 16px; margin-top: 5px; }
        .mensagem-boas-vindas { color: #27ae60; font-size: 15px; margin-top: 8px !important; }
        
      .btn-sair { 
            background-color: #ff6b6b; /* Vermelho mais claro e suave */
            box-shadow: 0 5px #ee5253; /* Sombra acompanhando o tom */
            width: auto; 
            padding: 10px 25px; 
            margin-bottom: 0; 
            margin-left: auto;
        }
        
        /* Containers e Cart√µes Brancos */
        .cartao-branco { background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 8px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .cartao-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; color: #2c3e50; flex-wrap: wrap; gap: 10px; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px;}
        .cartao-header h3 { display: flex; align-items: center; gap: 8px; }

/* Grade Semanal e Navega√ß√£o */
        .navegacao-semana { display: flex; gap: 10px; align-items: center; justify-content: center; }
        
        .btn-nav { 
            background-color: #ecf0f1; 
            color: #2c3e50; 
            box-shadow: 0 4px #bdc3c7; 
            padding: 8px 5px; 
            font-size: 14px; 
            margin: 0; 
            flex: 1; /* Esta linha faz todos os bot√µes terem a mesma largura */
            min-width: 95px; /* Garante que n√£o fiquem muito espremidos no celular */
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Bot√£o Hoje com um azul mais claro e harmonioso */
        .btn-hoje { 
            background-color: #3498db; 
            color: white; 
            box-shadow: 0 4px #2980b9; 
        }
        
        .grade-dias { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .dia-coluna { display: flex; flex-direction: column; gap: 10px; }
        .dia-titulo { text-align: center; font-weight: bold; color: #34495e; padding-bottom: 5px; border-bottom: 2px solid #ecf0f1; font-size: 14px; }
        .dia-titulo span { display: block; font-size: 12px; color: #7f8c8d; font-weight: normal; }
        
        .turno-bloco { padding: 15px 10px; border-radius: 8px; text-align: center; font-weight: bold; color: white; cursor: pointer; font-size: 14px; box-shadow: 0 5px rgba(0,0,0,0.3); transition: all 0.1s; min-height: 120px; }
        .turno-bloco:active { box-shadow: 0 2px rgba(0,0,0,0.3); transform: translateY(3px); }
        .turno-unico { background-color: #34495e; border: 2px solid #2c3e50; } 

        .horario-grupo { background: rgba(255, 255, 255, 0.95); border-radius: 6px; padding: 6px; margin-bottom: 10px; text-align: left; box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .horario-header { font-size: 12px; font-weight: bold; padding: 5px; border-radius: 4px; color: white; text-align: center; margin-bottom: 6px; }
        .horario-nomes { font-size: 13px; line-height: 1.5; color: #2c3e50; font-weight: normal; padding-left: 5px; }
        
        .cor-hora-0 { background-color: #95a5a6; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-1 { background-color: #2ecc71; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-2 { background-color: #f1c40f; color: #2c3e50 !important; } 
        .cor-hora-3 { background-color: #e67e22; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 
        .cor-hora-4 { background-color: #e74c3c; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); } 

        /* Observa√ß√µes e Rodap√© */
        textarea { width: 100%; height: 120px; padding: 12px; border: 1px solid #ccc; border-radius: 6px; resize: none; font-family: inherit; margin-bottom: 15px; line-height: 1.5; }
        .botoes-rodape { display: flex; gap: 10px; flex-wrap: wrap; }
        .botoes-rodape button { flex: 1; margin-bottom: 0; min-width: 150px; } 

        /* GRAVA√á√ÉO DE √ÅUDIO & MIDIA */
        .btn-gravar { background-color: #e74c3c; box-shadow: 0 5px #c0392b; display: flex; justify-content: center; align-items: center; gap: 8px; }
        .btn-gravar.gravando { background-color: #8c1e12; box-shadow: 0 2px #5e1109; transform: translateY(3px); }
        
        .lista-audios { margin-top: 15px; display: flex; flex-direction: column; gap: 10px; }
        .item-audio { background: #f8f9fa; padding: 10px; border-radius: 8px; border: 1px solid #dee2e6; }
        .item-audio-header { display: flex; justify-content: space-between; font-size: 12px; color: #7f8c8d; margin-bottom: 5px; font-weight: bold; }
        .item-audio-header span.nome { color: #2980b9; }
        audio { width: 100%; height: 35px; outline: none; }

        /* GALERIA DE FOTOS */
        .btn-foto { background-color: #9b59b6; box-shadow: 0 5px #8e44ad; }
        .grade-fotos { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 15px; }
        .cartao-foto { position: relative; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid #ecf0f1; background: #000; }
        .cartao-foto img { width: 100%; height: 140px; object-fit: cover; display: block; }
        .legenda-foto { position: absolute; bottom: 0; left: 0; width: 100%; background: rgba(0,0,0,0.7); color: white; font-size: 11px; padding: 5px; text-align: center; }

        /* MODAL DE AGENDAMENTO */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); justify-content: center; align-items: center; z-index: 1000; padding: 10px; }
        .modal-conteudo { background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto; display: flex; flex-direction: column; }
        .modal-conteudo h3 { color: #2c3e50; border-bottom: 2px solid #ecf0f1; padding-bottom: 10px; margin-bottom: 15px; text-align: center; }
        
        .lista-visitas-modal { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; margin-bottom: 15px; max-height: 200px; overflow-y: auto; }
        .item-visita-modal { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px dashed #ccc; font-size: 13px; color: #34495e; }
        .item-visita-modal:last-child { border-bottom: none; }
        .btn-apagar-modal { background: #fadbd8; color: #c0392b; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; box-shadow: none; width: auto; margin: 0; }
        .btn-apagar-modal:hover { background: #f5b7b1; }

        .form-nova-visita { background: #eaf2f8; padding: 15px; border-radius: 8px; border: 1px solid #d4e6f1; }
        .form-nova-visita label { font-size: 13px; font-weight: bold; color: #2980b9; margin-bottom: 10px; display: block; }
        .form-nova-visita input[type="text"] { width: 100%; padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 14px; margin-bottom: 10px; }
        
        .linha-horario { display: flex; align-items: center; gap: 8px; font-size: 14px; color: #34495e; }
        .linha-horario input[type="text"].input-hora { padding: 10px; border: 1px solid #bdc3c7; border-radius: 4px; font-size: 15px; flex: 1; text-align: center; font-weight: bold; color: #2c3e50;}
        .aviso-regra { font-size: 11px; color: #7f8c8d; margin-top: 8px; line-height: 1.3; }

        .modal-botoes { display: flex; gap: 10px; margin-top: 20px; }
        .btn-salvar { background-color: #2ecc71; box-shadow: 0 5px #27ae60; flex: 1; margin-bottom: 0; } 
        .btn-salvar:active { box-shadow: 0 2px #27ae60; }
        .btn-cancelar { background-color: #95a5a6; box-shadow: 0 5px #7f8c8d; flex: 1; margin-bottom: 0;} 
        .btn-cancelar:active { box-shadow: 0 2px #7f8c8d; }

        /* TELA DE RELAT√ìRIO */
        #tela-relatorio { display: none; padding: 40px; background: white; width: 98%; max-width: 1400px; margin: 20px auto; border-radius: 12px; }
        .tabela-relatorio { width: 100%; border-collapse: collapse; margin-top: 20px;}
        .tabela-relatorio th, .tabela-relatorio td { border: 1px solid #bdc3c7; padding: 10px; text-align: left;}

        @media (max-width: 768px) {
            .grade-dias { grid-template-columns: 1fr; }
            .botoes-rodape { flex-direction: column; }
            .botoes-rodape button { width: 100%; }
            .cartao-header { flex-direction: column; text-align: center; }
        }
        
@media print {
            /* Zeramos a margem da impressora para n√≥s mesmos controlarmos */
            @page { margin: 0; }
            
            body { background: white; margin: 0; padding: 0; }
            .no-print, #tela-painel, #tela-login { display: none !important; }
            
            #tela-relatorio { 
                display: block !important; 
                width: 85% !important; 
                /* AQUI EST√Å O SEGREDO! A ordem √©: Cima | Direita | Baixo | Esquerda */
                margin: 2cm auto 2cm auto !important; 
                padding: 0 !important;
            }

            .tabela-relatorio th, .tabela-relatorio td {
                padding: 8px;
                font-size: 14px;
            }
            
            #obs-relatorio-texto {
                font-size: 14px;
            }
        }

    </style>
</head>
<body>

<div id="tela-login">
        <div class="cartao-login">
            <h2>Controle de Visitas</h2>
            <p>Paciente: Arlinda Batista Passos</p>
            <div class="input-grupo"><input type="text" id="nome-visitante" placeholder="Seu Nome (Visitante/Cuidador)" required></div>
            <div class="input-grupo">
                <input type="password" id="senha-acesso" placeholder="Senha de Acesso" required>
                <span class="olhinho" onclick="toggleSenha()">üëÅÔ∏è</span>
            </div>
            
            <button onclick="fazerLogin()" style="background-color: #d6eaf8; color: #2c3e50; box-shadow: 0 5px #aed6f1; padding: 12px; border: none; border-radius: 6px; width: 100%; font-size: 16px; font-weight: bold; margin-bottom: 10px;">üîë Entrar</button>
            
            <p id="mensagem-erro">Senha incorreta ou nome em branco!</p>
        </div>
    </div>

<div id="tela-painel">
        <div class="cabecalho-paciente cartao-branco">
            <div class="foto-container">
                <img src="mae.jpg" alt="Foto Dona Arlinda" class="foto-paciente" onerror="this.src='https://via.placeholder.com/90?text=Sem+Foto'">
            </div>
            <div class="info-paciente">
                <h2>Arlinda Batista Passos</h2>
                <p><strong>Rua:</strong> √Ågua Marinha, 409</p>
                <p id="boas-vindas-texto" class="mensagem-boas-vindas"></p>
            </div>
            
            <button class="btn-sair" onclick="sairDoSistema()" style="background-color: #fadbd8; color: #2c3e50; box-shadow: 0 5px #f5b7b1; border: none; font-weight: bold;">üëã Sair</button>
        </div>

<div class="cartao-branco">
            <div class="cartao-header">
                <h3>üóìÔ∏è Agenda de Visitas/Cuidadores</h3>
                <div class="navegacao-semana">
                    <button class="btn-nav" onclick="mudarSemana(-7)">‚¨ÖÔ∏è Ant.</button>
                    
                    <button class="btn-nav btn-hoje" onclick="irParaHoje()" style="background-color: #d6eaf8; color: #2c3e50; box-shadow: 0 4px #aed6f1; border: none; font-weight: bold;">Hoje</button>
                    
                    <button class="btn-nav" onclick="mudarSemana(7)">Pr√≥x. ‚û°Ô∏è</button>
                </div>
            </div>
            <div class="grade-dias" id="grade-dias"></div>
        </div>

       <div class="cartao-branco">
            <div class="cartao-header" style="border-bottom:none; margin-bottom: 5px;">
                <h3>ü©∫ Informa√ß√µes Relevantes</h3>
<button onclick="inserirDataObs()" style="background-color: #fdebd0; color: #2c3e50; box-shadow: 0 4px #fad7a1; border: none; width: auto; padding: 6px 15px; margin: 0; font-size: 13px; font-weight: bold;">üóìÔ∏è Inserir Data / Texto</button>
            </div>
            <textarea id="texto-observacoes" placeholder="Digite informa√ß√µes m√©dicas, dieta, estado geral..."></textarea>
            
            <div class="botoes-rodape" style="margin-bottom: 15px;">
                <button onclick="salvarObservacao()" style="background-color: #d5f5e3; color: #2c3e50; box-shadow: 0 5px #a9dfbf;">üíæ Salvar Texto</button>
                <button id="btn-gravar-info" class="btn-gravar" onclick="alternarGravacao('info')" style="background-color: #fadbd8; color: #2c3e50; box-shadow: 0 5px #f5b7b1;">üé§ Gravar Informa√ß√µes Relevantes</button>
            </div>
            
            <div id="lista-audios-info" class="lista-audios"></div>
            
            <div class="botoes-rodape" style="margin-top: 20px; border-top: 1px solid #ecf0f1; padding-top: 15px;">
                <button style="background-color: #d5f5e3; color: #2c3e50; box-shadow: 0 5px #a9dfbf;" onclick="abrirRelatorio()">üìÑ Gerar Relat√≥rio</button>
                <button style="background-color: #fadbd8; color: #2c3e50; box-shadow: 0 5px #f5b7b1;" onclick="enviarWhatsApp()">üì≤ Enviar WhatsApp</button>
            </div>
        </div>

<div class="cartao-branco" style="border: 2px solid #fd79a8; background: #fff0f6;">
            <div class="cartao-header" style="border-color: #fab1a0;">
                <h3 style="color: #d63031;">üíå Recadinhos para a Dindinha</h3>
                <p style="font-size: 13px; color: #e17055;">Deixe uma mensagem de voz carinhosa para ela ouvir!</p>
            </div>
            <button id="btn-gravar-recado" class="btn-gravar" style="background-color: #fadbd8; color: #2c3e50; box-shadow: 0 5px #f5b7b1;" onclick="alternarGravacao('recadinho')">üé§üíñ Gravar Novo Recadinho</button>
            <div id="lista-audios-recadinhos" class="lista-audios"></div>
        </div>

        <div class="cartao-branco">
            <div class="cartao-header">
                <h3>üì∏ Mural de Fotos com a Dindinha</h3>
                <p style="font-size: 13px; color: #7f8c8d;">Registre e eternize as visitas!!!</p>
            </div>
            
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="file" id="input-foto-cam" accept="image/*" capture="environment" style="display:none" onchange="subirFotoGaleria(event)">
                <input type="file" id="input-foto-gal" accept="image/*" style="display:none" onchange="subirFotoGaleria(event)">
                
                <button class="btn-foto" style="flex:1; background-color: #e8daef; color: #2c3e50; box-shadow: 0 5px #d7bde2;" onclick="document.getElementById('input-foto-cam').click()">üì∑ Abrir C√¢mera</button>
                <button class="btn-foto" style="flex:1; background-color: #fdebd0; color: #2c3e50; box-shadow: 0 5px #fad7a1;" onclick="document.getElementById('input-foto-gal').click()">üñºÔ∏è Escolher da Galeria</button>
            </div>
            
            <div id="grade-fotos" class="grade-fotos"></div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-conteudo">
            <h3 id="modal-titulo">Agendar Hor√°rio</h3>
            
            <div id="lista-visitas-modal" class="lista-visitas-modal"></div>
            
            <div class="form-nova-visita">
                <label>‚ûï Adicionar Novo Visitante</label>
                <input type="text" id="novo-nome" placeholder="Nome">
                <div class="linha-horario">
                    Das <input type="text" class="input-hora" id="novo-inicio" placeholder="00:00" maxlength="5" inputmode="numeric" oninput="formatarHora(this)"> 
                    √†s <input type="text" class="input-hora" id="novo-fim" placeholder="00:00" maxlength="5" inputmode="numeric" oninput="formatarHora(this)">
                </div>
                <p class="aviso-regra">‚ö†Ô∏è <strong>Regra:</strong> As Visitas s√£o agendadas com Intervalo de 5 minutos.</p>
                <button onclick="adicionarNaListaModal()" style="background-color: #3498db; box-shadow: 0 4px #2980b9; padding: 10px; margin-top: 10px; font-size: 15px; margin-bottom: 0; width: 100%;">Confirmar Hor√°rio</button>
            </div>
            
            <div class="modal-botoes">
                <button class="btn-cancelar" onclick="fecharModal()">Cancelar (Sair)</button>
                <button class="btn-salvar" onclick="salvarVisitasNuvem()">Salvar Agenda</button>
            </div>
        </div>
    </div>

<div id="tela-relatorio">
        <div class="no-print" style="display: flex; gap:10px; margin-bottom: 20px;">
            <button onclick="fecharRelatorio()" style="background-color: #e8daef; color: #2c3e50; box-shadow: 0 5px #d7bde2; padding: 12px; border: none; border-radius: 6px; flex: 1; margin-bottom: 0;">üîô Voltar</button>
            
            <button onclick="window.print()" style="background-color: #d6eaf8; color: #2c3e50; box-shadow: 0 5px #aed6f1; padding: 12px; border: none; border-radius: 6px; flex: 1; margin-bottom: 0;">üñ®Ô∏è Imprimir</button>
        </div>
        <h2 style="text-align:center; color:#2c3e50;">üìñ Relat√≥rio de Visitas</h2>
        <table class="tabela-relatorio">
            <thead><tr><th>Dia</th><th>Visitas</th></tr></thead>
            <tbody id="corpo-tabela-relatorio"></tbody>
        </table>
        <h3 style="margin-top:20px;">Informa√ß√µes Relevantes</h3>
        <div id="obs-relatorio-texto" style="background:#f9f9f9; padding:15px; border-left:4px solid #3498db;"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURA√á√ÉO DO FIREBASE (Database + Storage)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDa7vGvKOKzCAlnIADGUbOtWpr-vZ8iUSY",
            authDomain: "controle-visitas-arlinda.firebaseapp.com",
            databaseURL: "https://controle-visitas-arlinda-default-rtdb.firebaseio.com",
            projectId: "controle-visitas-arlinda",
            storageBucket: "controle-visitas-arlinda.firebasestorage.app",
            messagingSenderId: "542401912473",
            appId: "1:542401912473:web:ad8628ceb4d511d6032208"
        };
        
        if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
        const db = firebase.database();
        const storage = firebase.storage();

        // Vari√°veis Globais
        let usuarioLogado = '';
        let diaEdicao = '';
        let diasAtivos = []; 
        let bancoDeDadosNuvem = {}; 
        let conexaoIniciada = false; 
        let deslocamentoDias = 0; 
        let listaTemporariaModal = []; 

        // Vari√°veis do Gravador de √Åudio
        let mediaRecorder;
        let audioChunks = [];
        let estadoGravacao = { info: false, recadinho: false };

        // ==========================================
        // LOGIN E CONEX√ÉO
        // ==========================================
        function toggleSenha() {
            const input = document.getElementById('senha-acesso');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

function fazerLogin() {
            const nomeDigitado = document.getElementById('nome-visitante').value.trim();
            const senhaDigitada = document.getElementById('senha-acesso').value;
            
            if ((senhaDigitada === '409' || senhaDigitada === '409') && nomeDigitado !== '') {
                usuarioLogado = nomeDigitado;
                
                // MENSAGEM NOVA AQUI:
                document.getElementById('boas-vindas-texto').innerHTML = `Oi, <strong>${usuarioLogado}</strong> - grato por sua visita!!!`;
                
                document.getElementById('tela-login').style.display = 'none';
                document.getElementById('tela-painel').style.display = 'block';
                iniciarConexaoNuvem(); 
            } else {
                document.getElementById('mensagem-erro').style.display = 'block';
            }
        }

        function sairDoSistema() {
            window.location.reload(); 
        }

        function iniciarConexaoNuvem() {
            atualizarPainel();
            if (!conexaoIniciada) {
                db.ref('visitasDonaArlinda').on('value', (snapshot) => {
                    bancoDeDadosNuvem = snapshot.val() || {};
                    gerarDiasDaSemana(); 
                });
                db.ref('obsDonaArlinda').on('value', (snapshot) => {
                    document.getElementById('texto-observacoes').value = snapshot.val() || '';
                });
                db.ref('audiosInfo').on('value', (snapshot) => {
                    renderizarAudios(snapshot.val(), 'lista-audios-info', false, 'audiosInfo');
                });
                db.ref('recadinhosFofos').on('value', (snapshot) => {
                    renderizarAudios(snapshot.val(), 'lista-audios-recadinhos', true, 'recadinhosFofos');
                });
                db.ref('muralFotos').on('value', (snapshot) => {
                    renderizarFotos(snapshot.val());
                });

                setInterval(gerarDiasDaSemana, 60000); 
                conexaoIniciada = true;
            }
        }

        // ==========================================
        // AGENDA (Tempo, Fatiamento e Modal)
        // ==========================================
        function mudarSemana(dias) { deslocamentoDias += dias; atualizarPainel(); }
        function irParaHoje() { deslocamentoDias = 0; atualizarPainel(); }

        function atualizarPainel() {
            diasAtivos = [];
            const nomesSemana = ['Domingo', 'Segunda', 'Ter√ßa', 'Quarta', 'Quinta', 'Sexta', 'S√°bado'];
            let hojeReal = new Date();
            let stringHojeReal = hojeReal.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});

            for(let i = 0; i < 7; i++) {
                let dataObj = new Date();
                dataObj.setDate(dataObj.getDate() + deslocamentoDias + i); 
                let dataFormatada = dataObj.toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit'});
                diasAtivos.push({ 
                    idUnico: dataFormatada.replace(/\//g, '-'), 
                    tituloPrincipal: (dataFormatada === stringHojeReal) ? 'Hoje' : nomesSemana[dataObj.getDay()], 
                    subTitulo: dataFormatada, 
                    objetoData: dataObj 
                });
            }
            gerarDiasDaSemana();
        }

        function converterParaMinutos(horaString) {
            let [h, m] = horaString.split(':').map(Number);
            return h * 60 + m;
        }

        function minutosParaHora(minutosTotal) {
            let h = Math.floor(minutosTotal / 60);
            let m = minutosTotal % 60;
            if (h >= 24) h -= 24; 
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function formatarHora(campo) {
            let valor = campo.value.replace(/\D/g, ''); 
            if (valor.length >= 3) { campo.value = valor.substring(0, 2) + ':' + valor.substring(2, 4); } 
            else { campo.value = valor; }
        }

        function gerarDiasDaSemana() {
            const gradeDias = document.getElementById('grade-dias');
            if(!gradeDias) return; 
            gradeDias.innerHTML = '';

            diasAtivos.forEach(diaInfo => {
                let listaVisitas = bancoDeDadosNuvem[diaInfo.idUnico] || [];
                let htmlVisitas = '<div style="margin-top: 10px;">';
                
                if (listaVisitas.length === 0) {
                    htmlVisitas += `<div class="horario-grupo cor-hora-0"><div style="text-align: center; color: white; padding: 5px; font-weight:bold; display: flex; align-items: center; justify-content: center; gap: 5px;">Nenhuma Visita <span style="font-size: 24px;">üò¢</span></div></div>`;
                } else {
                    let eventos = [];
                    listaVisitas.forEach(v => {
                        let minI = converterParaMinutos(v.inicio);
                        let minF = converterParaMinutos(v.fim);
                        if (minF <= minI) minF += 24 * 60; 
                        eventos.push({ time: minI, type: 'start', nome: v.nome });
                        eventos.push({ time: minF, type: 'end', nome: v.nome });
                    });
                    eventos.sort((a, b) => a.time !== b.time ? a.time - b.time : (a.type === 'end' ? -1 : 1));

                    let blocos = [], visitantesAtuais = [], tempoAnterior = null;
                    eventos.forEach(evento => {
                        if (tempoAnterior !== null && evento.time > tempoAnterior && visitantesAtuais.length > 0) {
                            blocos.push({ inicio: tempoAnterior, fim: evento.time, nomes: [...visitantesAtuais] });
                        }
                        if (evento.type === 'start') visitantesAtuais.push(evento.nome);
                        else visitantesAtuais.splice(visitantesAtuais.indexOf(evento.nome), 1);
                        tempoAnterior = evento.time;
                    });

                    blocos.forEach(bloco => {
                        let qtd = bloco.nomes.length;
                        let corClasse = qtd === 1 ? 'cor-hora-1' : (qtd === 2 ? 'cor-hora-2' : (qtd <= 4 ? 'cor-hora-3' : 'cor-hora-4'));
                        let carinhas = '<span style="font-size: 24px; vertical-align: middle; margin-left: 5px;">' + 'üôÇ'.repeat(Math.min(qtd, 6)) + '</span>';
                        
                        let horaI = minutosParaHora(bloco.inicio);
                        let horaF = minutosParaHora(bloco.fim);
                        
                        let expirou = false;
                        let [hFim, mFim] = horaF.split(':').map(Number);
                        let dataHoraFim = new Date(diaInfo.objetoData.getTime());
                        dataHoraFim.setHours(hFim, mFim, 0, 0);
                        if (new Date() > dataHoraFim) expirou = true;

                        htmlVisitas += `
                        <div class="horario-grupo" style="${expirou ? 'opacity: 0.5;' : ''}">
                            <div class="horario-header ${corClasse}">‚è±Ô∏è ${horaI} √†s ${horaF} ${carinhas}</div>
                            <div class="horario-nomes">
                                ${bloco.nomes.map(nome => expirou ? `‚Ä¢ <s style="color:#7f8c8d;"><strong>${nome}</strong></s>` : `‚Ä¢ <strong>${nome}</strong>`).join('<br>')}
                            </div>
                        </div>`;
                    });
                }
                htmlVisitas += '</div>';

                const divColuna = document.createElement('div');
                divColuna.className = 'dia-coluna';
                divColuna.innerHTML = `
                    <div class="dia-titulo"><span style="font-size:14px; font-weight:bold; ${diaInfo.tituloPrincipal === 'Hoje' ? 'color:#3498db;' : ''}">${diaInfo.tituloPrincipal}</span> <span>${diaInfo.subTitulo}</span></div>
                    <div class="turno-bloco turno-unico" onclick="abrirModal('${diaInfo.idUnico}', '${diaInfo.tituloPrincipal}')">Gest√£o do Dia ${htmlVisitas}</div>
                `;
                gradeDias.appendChild(divColuna);
            });
        }

        function abrirModal(idData, nomeExibicao) {
            diaEdicao = idData;
            document.getElementById('modal-titulo').innerText = `${nomeExibicao} (${idData.replace('-', '/')})`;
            listaTemporariaModal = [...(bancoDeDadosNuvem[idData] || [])];
            document.getElementById('novo-nome').value = ''; document.getElementById('novo-inicio').value = ''; document.getElementById('novo-fim').value = '';
            atualizarListaNoModal();
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function fecharModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        function atualizarListaNoModal() {
            const divLista = document.getElementById('lista-visitas-modal');
            divLista.innerHTML = '';
            if (listaTemporariaModal.length === 0) {
                divLista.innerHTML = '<div style="text-align:center; color:#7f8c8d; padding:10px;">Nenhum hor√°rio agendado.</div>';
                return;
            }
            listaTemporariaModal.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            listaTemporariaModal.forEach((visita, index) => {
                divLista.innerHTML += `
                <div class="item-visita-modal">
                    <div><strong>${visita.inicio} √†s ${visita.fim}</strong><br><strong>${visita.nome}</strong></div>
                    <button class="btn-apagar-modal" onclick="listaTemporariaModal.splice(${index}, 1); atualizarListaNoModal();">üóëÔ∏è Excluir</button>
                </div>`;
            });
        }

        function adicionarNaListaModal() {
            const nome = document.getElementById('novo-nome').value.trim();
            const inicio = document.getElementById('novo-inicio').value;
            const fim = document.getElementById('novo-fim').value;

            if (nome === '' || inicio.length !== 5 || fim.length !== 5) { alert("Preencha o nome e o hor√°rio completo (Ex: 14:05)!"); return; }
            let [hIni, mIni] = inicio.split(':').map(Number); let [hFim, mFim] = fim.split(':').map(Number);
            if (isNaN(hIni) || isNaN(mIni) || isNaN(hFim) || isNaN(mFim) || hIni > 23 || mIni > 59 || hFim > 23 || mFim > 59) { alert("Hor√°rio inv√°lido!"); return; }
            if (mIni % 5 !== 0 || mFim % 5 !== 0) { alert("Apenas intervalos exatos de 5 minutos!"); return; }

            listaTemporariaModal.push({ nome: nome, inicio: inicio, fim: fim });
            document.getElementById('novo-nome').value = ''; document.getElementById('novo-inicio').value = ''; document.getElementById('novo-fim').value = '';
            atualizarListaNoModal();
        }

        function salvarVisitasNuvem() {
            bancoDeDadosNuvem[diaEdicao] = listaTemporariaModal;
            db.ref('visitasDonaArlinda').set(bancoDeDadosNuvem).then(() => fecharModal()).catch(e => alert("Erro: " + e.message));
        }

        // ==========================================
        // TEXTO E WHATSAPP
        // ==========================================
function inserirDataObs() {
            const t = document.getElementById('texto-observacoes');
            const dataFormatada = `üóìÔ∏è ${new Date().toLocaleDateString('pt-BR')}\n`;
            
            // Se a caixa estiver vazia, apenas coloca a data
            if (t.value.trim() === '') {
                t.value = dataFormatada;
            } else {
                // Se j√° tiver texto, coloca a data no topo, d√° um espa√ßo, e mant√©m o texto antigo embaixo
                t.value = dataFormatada + '\n' + t.value;
            }
            
            t.focus();
            // Coloca o cursor do teclado piscando logo depois da data inserida
            t.setSelectionRange(dataFormatada.length, dataFormatada.length); 
        }

        function salvarObservacao() {
            db.ref('obsDonaArlinda').set(document.getElementById('texto-observacoes').value)
              .then(() => alert('‚úÖ Informa√ß√µes salvas com sucesso!'))
              .catch(e => alert('Erro: ' + e.message));
        }

        function enviarWhatsApp() {
            let hoje = new Date().toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            let ama = new Date(new Date().setDate(new Date().getDate() + 1)).toLocaleDateString('pt-BR', {day:'2-digit', month:'2-digit'});
            
            let hVis = bancoDeDadosNuvem[hoje.replace(/\//g, '-')] || []; hVis.sort((a,b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            let aVis = bancoDeDadosNuvem[ama.replace(/\//g, '-')] || []; aVis.sort((a,b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
            
            let txt = `*Agenda Dona Arlinda*\n\nüìÖ *HOJE (${hoje})*\n`;
            txt += hVis.length ? hVis.map(v => `- ${v.inicio} √†s ${v.fim}: *${v.nome}*`).join('\n') : 'Livre';
            txt += `\n\nüìÖ *AMANH√É (${ama})*\n`;
            txt += aVis.length ? aVis.map(v => `- ${v.inicio} √†s ${v.fim}: *${v.nome}*`).join('\n') : 'Livre';

            window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
        }

        // ==========================================
        // EXCLUS√ÉO DE M√çDIA (FOTOS E √ÅUDIOS)
        // ==========================================
        async function deletarMidia(caminhoDB, idNode, urlArquivo, autorItem) {
            const senhaMestreReal = "409"; 
            
            // Padroniza o nome para ignorar acentos e mai√∫sculas (j√∫nior = junior = JUNIOR)
            const nomeLogado = usuarioLogado.trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const isJunior = nomeLogado === "junior";

            // Verifica as permiss√µes
            if (usuarioLogado !== autorItem) {
                if (isJunior) {
                    const senha = prompt(`J√∫nior, digite a Senha Mestre para apagar o arquivo de ${autorItem}:`);
                    if (senha !== senhaMestreReal) {
                        if (senha !== null) alert("‚ùå Senha Mestre Incorreta!");
                        return; // Para a execu√ß√£o se a senha for errada
                    }
                } else {
                    alert("‚ùå A√ß√£o bloqueada! Voc√™ s√≥ pode apagar os seus pr√≥prios arquivos.");
                    return; // Para a execu√ß√£o
                }
            } else {
                // Se for o pr√≥prio autor logado, apenas pede confirma√ß√£o
                if (!confirm("Tem certeza que deseja apagar este arquivo permanentemente?")) return;
            }

            // 1. Exclui do Firebase Storage
            try {
                const refArquivo = firebase.storage().refFromURL(urlArquivo);
                await refArquivo.delete();
            } catch (error) {
                console.warn("Aviso: Arquivo n√£o encontrado no Storage ou j√° deletado.", error);
            }

            // 2. Exclui do Firebase Realtime Database
            try {
                await db.ref(caminhoDB).child(idNode).remove();
            } catch (error) {
                alert("Erro ao remover do banco de dados: " + error.message);
            }
        }

        // ==========================================
        // √ÅUDIO - GRAVA√á√ÉO E UPLOAD
        // ==========================================
        async function alternarGravacao(tipo) {
            const btnId = tipo === 'info' ? 'btn-gravar-info' : 'btn-gravar-recado';
            const btn = document.getElementById(btnId);
            const dbPath = tipo === 'info' ? 'audiosInfo' : 'recadinhosFofos';

            if (!estadoGravacao[tipo]) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = e => { if(e.data.size > 0) audioChunks.push(e.data); };
                    
                    mediaRecorder.onstop = () => {
                        btn.classList.remove('gravando');
                        btn.disabled = true;

                        const audioBlob = new Blob(audioChunks, { type: mediaRecorder.mimeType || 'audio/webm' });
                        const nomeArquivo = `${Date.now()}_${usuarioLogado.replace(/[^a-zA-Z0-9]/g, '')}.webm`;
                        const pasta = tipo === 'info' ? 'audios_info' : 'audios_recados';
                        
                        const uploadTask = storage.ref(`${pasta}/${nomeArquivo}`).put(audioBlob);

                        uploadTask.on('state_changed',
                            (snapshot) => {
                                let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                btn.innerHTML = `‚è≥ Enviando... ${Math.round(progress)}%`;
                            },
                            (error) => {
                                alert("Erro no Firebase Storage: " + error.message);
                                btn.innerHTML = tipo === 'info' ? 'üé§ Gravar Informa√ß√µes Relevantes' : 'üíñ Gravar Novo Recadinho';
                                btn.disabled = false;
                            },
                            () => {
                                uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                                    db.ref(dbPath).push({
                                        nome: usuarioLogado,
                                        url: downloadURL,
                                        data: new Date().toLocaleString('pt-BR')
                                    }).then(() => {
                                        btn.innerHTML = tipo === 'info' ? 'üé§ Gravar √Åudio M√©dico' : 'üíñ Gravar Novo Recadinho';
                                        btn.disabled = false;
                                    });
                                });
                            }
                        );
                    };

                    mediaRecorder.start();
                    estadoGravacao[tipo] = true;
                    btn.innerHTML = 'üî¥ GRAVANDO... (Toque para Parar)';
                    btn.classList.add('gravando');

                } catch (err) { alert("Erro ao acessar microfone. Verifique as permiss√µes do navegador."); }
            } else {
                mediaRecorder.stop();
                estadoGravacao[tipo] = false;
            }
        }

        function renderizarAudios(dados, containerId, fofo = false, dbPath) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (!dados) return;

            let audios = Object.keys(dados).map(k => ({ id: k, ...dados[k] }));
            
            audios.sort((a, b) => {
                let da = a.data.split(' ')[0].split('/').reverse().join('') + a.data.split(' ')[1];
                let db = b.data.split(' ')[0].split('/').reverse().join('') + b.data.split(' ')[1];
                return db.localeCompare(da);
            });

            audios.forEach(aud => {
                let icone = fofo ? 'üíå' : 'ü©∫';
                container.innerHTML += `
                <div class="item-audio">
                    <div class="item-audio-header" style="align-items: center;">
                        <div style="flex-grow: 1;">
                            <span class="nome">${icone} ${fofo ? 'De:' : 'Por:'} <strong>${aud.nome}</strong></span>
                            <span style="display:block; font-size:11px; font-weight:normal; margin-top:2px;">${aud.data}</span>
                        </div>
                        <button onclick="deletarMidia('${dbPath}', '${aud.id}', '${aud.url}', '${aud.nome}')" style="background:none; border:none; font-size:18px; cursor:pointer; color:#e74c3c; box-shadow:none; width:auto; padding:5px;" title="Apagar √Åudio">üóëÔ∏è</button>
                    </div>
                    <audio controls src="${aud.url}" style="margin-top:5px;"></audio>
                </div>`;
            });
        }

        // ==========================================
        // FOTOS - UPLOAD E RENDERIZA√á√ÉO
        // ==========================================
        async function subirFotoGaleria(event) {
            const file = event.target.files[0];
            if (!file) return;

            const nomeArquivo = `${Date.now()}_${usuarioLogado.replace(/[^a-zA-Z0-9]/g, '')}.jpg`;
            
            const divLoad = document.createElement('div');
            divLoad.id = 'loading-foto';
            divLoad.innerHTML = "<em style='color:#8e44ad; font-size:13px; font-weight:bold;'>‚è≥ Enviando (0%)...</em>";
            document.getElementById('grade-fotos').prepend(divLoad);

            const uploadTask = storage.ref(`fotos/${nomeArquivo}`).put(file);

            uploadTask.on('state_changed',
                (snapshot) => {
                    let progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    document.getElementById('loading-foto').innerHTML = `<em style='color:#8e44ad; font-size:13px; font-weight:bold;'>‚è≥ Enviando (${Math.round(progress)}%)...</em>`;
                },
                (error) => {
                    alert("Erro ao enviar foto: " + error.message);
                    document.getElementById('loading-foto').remove();
                },
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        db.ref('muralFotos').push({
                            nome: usuarioLogado,
                            url: downloadURL,
                            data: new Date().toLocaleDateString('pt-BR')
                        });
                        document.getElementById('loading-foto').remove();
                    });
                }
            );
            event.target.value = ''; 
        }

        function renderizarFotos(dados) {
            const container = document.getElementById('grade-fotos');
            container.innerHTML = '';
            if (!dados) {
                container.innerHTML = '<p style="color:#7f8c8d; font-size:13px; grid-column: 1 / -1; text-align:center;">Ainda n√£o h√° fotos. Seja o primeiro a registrar um momento!</p>';
                return;
            }

            let fotos = Object.keys(dados).map(k => ({ id: k, ...dados[k] })).reverse(); 

            fotos.forEach(foto => {
                container.innerHTML += `
                <div class="cartao-foto">
                    <button onclick="deletarMidia('muralFotos', '${foto.id}', '${foto.url}', '${foto.nome}')" style="position:absolute; top:5px; right:5px; background:rgba(255,255,255,0.85); border:none; border-radius:50%; cursor:pointer; font-size:14px; box-shadow:0 2px 4px rgba(0,0,0,0.3); width:30px; height:30px; display:flex; align-items:center; justify-content:center; z-index:10;" title="Apagar Foto">üóëÔ∏è</button>
                    <a href="${foto.url}" target="_blank">
                        <img src="${foto.url}" alt="Foto com a Dona Arlinda">
                    </a>
                    <div class="legenda-foto">üì∏ ${foto.nome}<br>${foto.data}</div>
                </div>`;
            });
        }

        // ==========================================
        // RELAT√ìRIO
        // ==========================================
        function abrirRelatorio() {
            const corpo = document.getElementById('corpo-tabela-relatorio');
            corpo.innerHTML = '';
            diasAtivos.forEach(dia => {
                let lista = bancoDeDadosNuvem[dia.idUnico] || [];
                lista.sort((a, b) => converterParaMinutos(a.inicio) - converterParaMinutos(b.inicio));
                let txt = lista.length === 0 ? 'Livre' : lista.map(v => `${v.inicio}-${v.fim}: <strong>${v.nome}</strong>`).join('<br>');
                corpo.innerHTML += `<tr><td><strong>${dia.tituloPrincipal}</strong><br><span style="font-size:12px">${dia.subTitulo}</span></td><td>${txt}</td></tr>`;
            });
            document.getElementById('obs-relatorio-texto').innerHTML = document.getElementById('texto-observacoes').value.replace(/\n/g, '<br>');
            document.getElementById('tela-painel').style.display = 'none';
            document.getElementById('tela-relatorio').style.display = 'block';
        }

        function fecharRelatorio() {
            document.getElementById('tela-relatorio').style.display = 'none';
            document.getElementById('tela-painel').style.display = 'block';
        }

    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }
    </script>
</body>
</html>
